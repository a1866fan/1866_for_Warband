# -*- coding: UTF-8 -*-
####################################################################################################################
# Generated by Warband Module Decompiler
# All rights of the module belong to their respective owners
####################################################################################################################

from header_common import *
from header_operations import *
from header_mission_templates import *
from header_animations import *
from header_sounds import *
from header_music import *
from header_items import *
from header_parties import *
from module_constants import *

####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#     
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
# 
####################################################################################################################

pilgrim_disguise = [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff]
af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian

# copied from native
common_battle_init_banner = (
  ti_on_agent_spawn, 0, 0, [],
  [
    (store_trigger_param_1, ":agent_no"),
    (agent_get_troop_id, ":troop_no", ":agent_no"),
    (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":agent_no", ":troop_no"),
  ])


mission_templates = [
  ("town_default", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_scene_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_scene_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, 10, 
    [
      (eq, 0, 1),
      (try_begin),
        (key_is_down, key_left_alt),
        (key_is_down, key_f),
        (get_player_agent_no, ":var0"),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (try_begin),
          (eq, ":var1", "itm_springfield"),
          (assign, ":var1", "itm_springfield_61_bayonet"),
        (else_try),
          (eq, ":var1", "itm_springfield_61_bayonet"),
          (assign, ":var1", "itm_springfield"),
        (try_end),
        (try_for_range, ":var3", 0, 4),
          (troop_get_inventory_slot, ":var4", "trp_player", ":var3"),
          (eq, ":var4", ":var2"),
          (troop_set_inventory_slot, "trp_player", ":var3", ":var1"),
        (try_end),
        (assign, "$weapon_switch_conversation", 1),
        (start_mission_conversation, "trp_player"),
      (try_end),
      (key_is_down, key_right_alt),
      (key_is_down, key_f),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, 0, 1),
      (try_begin),
        (key_is_down, key_right_control),
        (key_is_down, key_f),
        (get_player_agent_no, ":var0"),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (try_begin),
          (eq, ":var1", "itm_springfield"),
          (assign, ":var1", "itm_springfield_61_bayonet"),
        (else_try),
          (eq, ":var1", "itm_springfield_61_bayonet"),
          (assign, ":var1", "itm_springfield"),
        (try_end),
        (try_for_range, ":var3", 0, 4),
          (troop_get_inventory_slot, ":var4", "trp_player", ":var3"),
          (eq, ":var4", ":var2"),
          (troop_set_inventory_slot, "trp_player", ":var3", ":var1"),
        (try_end),
        (assign, "$weapon_switch_conversation", 1),
        (start_mission_conversation, "trp_player"),
      (try_end),
    ],
    []),

    (0, 1, 3, 
    [
      (store_current_scene, ":var0"),
      (eq, ":var0", "scn_particle_test"),
      (try_begin),
        (key_clicked, key_numpad_1),
        (scene_prop_get_instance, ":var1", "spr_cannon_a", 0),
        (prop_instance_get_position, pos1, ":var1"),
        (position_move_y, pos1, 220),
        (position_move_z, pos1, 160),
        (call_script, "script_cannon_effects_grapeshot", 1),
      (try_end),
      (try_begin),
        (key_clicked, key_numpad_2),
        (scene_prop_get_instance, ":var1", "spr_cannon_a", 0),
        (prop_instance_get_position, pos1, ":var1"),
        (position_move_y, pos1, 220),
        (position_move_z, pos1, 160),
        (call_script, "script_cannon_effects_roundshot", 1),
      (try_end),
      (this_or_next|key_clicked, key_numpad_1),
      (key_clicked, key_numpad_2),
      (scene_prop_get_instance, ":var1", "spr_cannon_a", 0),
      (prop_instance_get_position, pos1, ":var1"),
      (position_move_y, pos1, -50),
      (prop_instance_animate_to_position, ":var1", pos1, 20),
      (store_random_in_range, reg1, 0, 4),
      (val_add, reg1, "snd_cannon_shot1"),
      (play_sound, reg1),
    ],
    [
      (scene_prop_get_instance, ":var0", "spr_cannon_a", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (position_move_y, pos1, 50),
      (prop_instance_animate_to_position, ":var0", pos1, 200),
    ]),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 65536),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("conversation_encounter", 0, -1,
  "Conversation encounter",
  [
    (0, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (1, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (2, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (3, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (4, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (5, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (6, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (7, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (8, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (9, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (10, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (11, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (12, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (13, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (14, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (15, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (16, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (17, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (18, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (19, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (20, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (21, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (22, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (23, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (24, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (25, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (26, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (27, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (28, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (29, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (30, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (31, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("town_center", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_4|mtef_scene_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (1, mtef_team_4|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_1|mtef_scene_source, 0, 0, 1, []),
    (14, mtef_team_1|mtef_scene_source, 0, 0, 1, []),
    (15, mtef_team_1|mtef_scene_source, 0, 0, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (51, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (52, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (53, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (54, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (55, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (56, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (57, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (58, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (59, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (60, mtef_team_4|mtef_visitor_source, af_override_horse, 0, 1, []),
    (61, mtef_team_4|mtef_visitor_source, af_override_horse, 0, 1, []),
    (62, mtef_team_4|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$warn_player", 0),
      (assign, "$g_player_warnings_left", 1),
      (assign, "$g_spawned_guards", 0),
      (team_set_relation, 0, 1, 0),
      (team_set_relation, 0, 2, 0),
      (team_set_relation, 0, 3, 0),
      (team_set_relation, 1, 2, 1),
      (team_set_relation, 1, 3, 1),
      (team_set_relation, 2, 3, -1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_hiding_spots", ":var0", 0),
      (try_end),
      (assign, "$murders", 0),
      (assign, "$murders_guard", 0),
      (assign, "$assaults", 0),
      (assign, "$assaults_guard", 0),
      (assign, "$robberies", 0),
      (assign, "$attempted_robberies", 0),
    ]),

    (1, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (neg|main_hero_fallen),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_get_slot, ":var2", ":var1", 14),
        (agent_get_slot, ":var3", ":var1", 15),
        (call_script, "script_get_distance_between_agents", ":var0", ":var1"),
        (assign, ":var4", reg0),
        (store_div, ":var5", ":var4", 700),
        (try_begin),
          (position_is_behind_position, pos2, pos1),
          (val_max, ":var5", 2),
        (try_end),
        (val_clamp, ":var5", 1, 3),
        (val_add, ":var2", 1),
        (store_random_in_range, ":var6", 0, ":var2"),
        (val_mul, ":var6", ":var5"),
        (val_sub, ":var3", ":var6"),
        (val_max, ":var3", 0),
        (agent_set_slot, ":var1", 15, ":var3"),
      (try_end),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_cf_shootout_init_town_agent", ":var0", "$current_town"),
    ],
    []),

    (1, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (neg|main_hero_fallen),
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (assign, ":var2", 1),
      (this_or_next|is_between, ":var1", "itm_javelin", "itm_torch"),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (neq, ":var3", ":var0"),
        (agent_get_team, ":var4", ":var3"),
        (neq, ":var4", 0),
        (neq, ":var4", 3),
        (agent_get_slot, ":var5", ":var3", 15),
        (agent_get_slot, ":var6", ":var3", 18),
        (agent_get_slot, ":var7", ":var3", 19),
        (agent_get_slot, ":var8", ":var3", 20),
        (agent_get_slot, ":var9", ":var3", 16),
        (agent_get_slot, ":var10", ":var3", 17),
        (agent_get_slot, ":var11", ":var3", 21),
        (agent_get_slot, ":var12", ":var3", 22),
        (agent_get_slot, ":var13", ":var3", 23),
        (agent_get_slot, ":var14", ":var3", 24),
        (agent_get_slot, ":var15", ":var3", 25),
        (agent_get_slot, ":var16", ":var3", 27),
        (try_begin),
          (store_agent_hit_points, ":var17", ":var3", 1),
          (neq, ":var17", ":var11"),
          (val_add, ":var5", ":var6"),
          (try_begin),
            (agent_is_alive, ":var3"),
            (this_or_next|eq, ":var13", 1),
            (call_script, "script_crime_committed", ":var3", "$current_town", 1),
          (else_try),
            (call_script, "script_crime_committed", ":var3", "$current_town", 2),
          (try_end),
          (assign, ":var13", 1),
          (assign, "$g_player_warnings_left", 0),
          (assign, ":var12", 1),
          (call_script, "script_nearby_agents_scatter", ":var3"),
        (else_try),
          (agent_is_alive, ":var3"),
          (game_key_is_down, 6),
          (eq, ":var2", 1),
          (neq, ":var14", 1),
          (call_script, "script_get_distance_between_agents", ":var3", ":var0"),
          (lt, reg0, 700),
          (call_script, "script_cf_agent_is_in_front_of_agent", ":var0", ":var3"),
          (call_script, "script_cf_agent_is_in_front_of_agent", ":var3", ":var0"),
          (val_max, ":var5", ":var7"),
          (assign, ":var12", 1),
        (else_try),
          (agent_is_alive, ":var3"),
          (neq, ":var12", 1),
          (assign, ":var18", 0),
          (try_for_agents, ":var19"),
            (eq, ":var18", 0),
            (neg|this_or_next|agent_is_alive, ":var19"),
            (agent_slot_eq, ":var19", 22, 1),
            (neq, ":var3", ":var19"),
            (call_script, "script_get_distance_between_agents", ":var3", ":var19"),
            (lt, reg0, ":var16"),
            (assign, ":var18", 1),
          (try_end),
          (eq, ":var18", 1),
          (val_max, ":var5", ":var8"),
          (assign, ":var12", 1),
        (try_end),
        (try_begin),
          (agent_is_alive, ":var3"),
          (eq, ":var12", 1),
          (eq, ":var15", 1),
          (gt, "$g_player_warnings_left", 0),
          (neg|game_key_is_down, 6),
          (assign, ":var14", 0),
        (else_try),
          (agent_is_alive, ":var3"),
          (eq, ":var12", 1),
          (this_or_next|le, "$g_player_warnings_left", 0),
          (eq, ":var15", 1),
          (lt, ":var5", ":var9"),
          (assign, ":var14", 1),
        (else_try),
          (agent_is_alive, ":var3"),
          (eq, ":var12", 1),
          (eq, ":var2", 1),
          (ge, ":var5", ":var10"),
          (call_script, "script_get_distance_between_agents", ":var3", ":var0"),
          (assign, ":var20", reg0),
          (lt, ":var20", 700),
          (try_begin),
            (lt, ":var20", 200),
            (call_script, "script_cf_agent_is_in_front_of_agent", ":var3", ":var0"),
            (call_script, "script_cf_agent_is_behind_agent", ":var0", ":var3"),
            (game_key_is_down, 6),
            (assign, ":var14", 4),
          (else_try),
            (assign, ":var14", 3),
          (try_end),
        (else_try),
          (agent_is_alive, ":var3"),
          (eq, ":var12", 1),
          (assign, ":var14", 2),
        (try_end),
        (agent_set_slot, ":var3", 15, ":var5"),
        (agent_set_slot, ":var3", 21, ":var17"),
        (agent_set_slot, ":var3", 22, ":var12"),
        (agent_set_slot, ":var3", 23, ":var13"),
        (call_script, "script_cf_set_town_agent_behavior", ":var3", ":var14"),
      (try_end),
    ],
    []),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (eq, "$g_mt_mode", 2),
      (assign, reg1, "$murders_guard"),
      (assign, reg2, "$murders"),
      (assign, reg3, "$assaults_guard"),
      (assign, reg4, "$assaults"),
      (assign, reg5, "$robberies"),
      (assign, reg6, "$attempted_robberies"),
      (assign, ":var0", 0),
      (val_add, ":var0", reg1),
      (val_add, ":var0", reg2),
      (val_add, ":var0", reg3),
      (val_add, ":var0", reg4),
      (val_add, ":var0", reg5),
      (val_add, ":var0", reg6),
      (assign, reg7, 0),
      (this_or_next|gt, ":var0", 0),
      (assign, reg7, 1),
      (str_store_string, s1, "@{reg1? {reg1} count(s) of first-degree murder on an officer of the peace^:}"),
      (str_store_string, s2, "@{reg2? {reg2} count(s) of first-degree murder^:}"),
      (str_store_string, s3, "@{reg3? {reg3} count(s) of assault on an officer of the peace^:}"),
      (str_store_string, s4, "@{reg4? {reg4} count(s) of simple assault^:}"),
      (str_store_string, s5, "@{reg5? {reg5} count(s) of robbery^:}"),
      (str_store_string, s6, "@{reg6? {reg6} count(s) of attempted robbery^:}"),
      (str_store_string, s7, "@{reg7? {reg7} count(s) of disturbing the peace^:}"),
      (str_store_string, s20, "@^^{s1}{s2}{s3}{s4}{s5}{s6}{s7}^"),
      (party_get_slot, ":var1", "$current_town", 26),
      (val_clamp, ":var1", -100, 0),
      (store_mul, "$bail_amount", -500, ":var1"),
      (store_random_in_range, ":var2", 0, 100),
      (val_add, "$bail_amount", ":var2"),
      (jump_to_menu, "mnu_captured_in_town"),
      (finish_mission),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (neg|agent_is_alive, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (neq, ":var1", ":var3"),
        (agent_get_slot, ":var4", ":var2", 30),
        (gt, ":var4", 0),
        (call_script, "script_get_distance_between_agents", ":var0", ":var2"),
        (lt, reg0, 200),
        (call_script, "script_rob_agent", ":var2"),
      (try_end),
    ]),

    (1, 0, 60, 
    [
      (eq, "$g_mt_mode", 2),
      (party_get_slot, ":var0", "$current_town", 26),
      (val_clamp, ":var0", -100, 0),
      (call_script, "script_get_random_prop_instance", "spr_guard_spawn"),
      (try_begin),
        (display_message, "@inside first try block"),
        (lt, ":var0", -80),
        (store_add, ":var1", ":var0", 80),
        (val_max, ":var1", -20),
        (val_mul, ":var1", -1),
        (store_mod, ":var2", ":var1", 10),
        (call_script, "script_spawn_alerted_agents_from_faction_slot", 52, 0, ":var2"),
      (try_end),
      (try_begin),
        (display_message, "@inside second try block"),
        (lt, ":var0", -50),
        (store_add, ":var1", ":var0", 50),
        (val_max, ":var1", -30),
        (val_mul, ":var1", -1),
        (store_mod, ":var2", ":var1", 10),
        (call_script, "script_spawn_alerted_agents_from_faction_slot", 51, 0, ":var2"),
      (try_end),
      (try_begin),
        (display_message, "@inside third try block"),
        (assign, ":var1", ":var0"),
        (val_max, ":var1", -50),
        (val_mul, ":var1", -1),
        (store_mod, ":var2", ":var1", 10),
        (call_script, "script_spawn_alerted_agents_from_faction_slot", 49, 0, ":var2"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$spawn_bottle_troops", 1),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (assign, ":var1", -1),
      (try_for_agents, ":var2"),
        (agent_get_entry_no, ":var3", ":var2"),
        (this_or_next|eq, ":var3", 260),
        (this_or_next|eq, ":var3", 61),
        (eq, ":var3", 62),
        (assign, ":var1", ":var2"),
      (try_end),
      (ge, ":var1", 0),
      (agent_get_position, pos1, ":var0"),
      (agent_get_position, pos2, ":var1"),
      (get_distance_between_positions, ":var4", pos1, pos2),
      (gt, ":var4", 500),
      (assign, ":var5", 99999),
      (assign, ":var6", 0),
      (try_for_range, ":var7", 0, 36),
        (copy_position, pos3, pos1),
        (val_mul, ":var7", 10),
        (position_rotate_z, pos3, ":var7"),
        (position_move_y, pos3, 400),
        (get_distance_between_positions, ":var4", pos1, pos3),
        (lt, ":var4", ":var5"),
        (assign, ":var6", ":var7"),
      (try_end),
      (copy_position, pos3, pos1),
      (position_rotate_z, pos3, ":var6"),
      (position_move_y, pos3, 200),
      (agent_set_scripted_destination, ":var1", pos3, 1),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (try_begin),
          (ge, "$duel", 1),
          (eq, "$duel_quest", "qst_billy_barrett"),
          (str_store_string, s2, "@You failed to complete this quest."),
          (add_quest_note_from_sreg, "qst_billy_barrett", 9, s2, 0),
          (fail_quest, "qst_billy_barrett"),
          (display_message, "str_quest_log_updated"),
        (try_end),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 2),
        (display_message, "@Town is hostile, reach the outskirts to escape."),
      (else_try),
        (display_message, "@Cannot leave now."),
      (try_end),
    ],
    []),

    (1, 0, ti_once, 
    [
      (eq, "$duel", 1),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$duel_partner"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (assign, "$duel", 0),
      (try_begin),
        (main_hero_fallen),
        (try_begin),
          (eq, "$duel_partner", "trp_barrett"),
          (jump_to_menu, "mnu_barrett_duel_lost"),
          (eq, "$duel_quest", "qst_billy_barrett"),
          (str_store_string, s2, "@You failed."),
          (add_quest_note_from_sreg, "qst_billy_barrett", 6, s2, 0),
          (fail_quest, "qst_billy_barrett"),
          (display_message, "str_quest_log_updated"),
        (try_end),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -10),
        (try_begin),
          (eq, "$duel_quest", "qst_billy_barrett"),
          (eq, "$duel_partner", "trp_barrett"),
          (troop_set_slot, "$duel_partner", 142, 0),
          (troop_add_gold, "trp_player", 800),
          (quest_set_slot, "qst_billy_barrett", 22, 800),
          (str_store_string, s2, "@Return to the undertaker."),
          (add_quest_note_from_sreg, "qst_billy_barrett", 6, s2, 0),
          (quest_set_slot, "qst_billy_barrett", 11, 5),
          (display_message, "@You picked up 8 dollars from the old man's body."),
          (display_message, "str_quest_log_updated"),
        (else_try),
          (troop_add_gold, "trp_player", "$duel_reward"),
        (try_end),
      (try_end),
    ]),

    (5, 0, 0, 
    [
      (eq, "$duel", 2),
    ],
    [
      (play_track, "track_wind", 1),
      (dialog_box, "@You are participating in a duel. Leave your gun in the holster, dismount and step 8 meters away from your enemy.", "@Duel!"),
    ]),

    (0, 1, 0, 
    [
      (eq, "$duel", 2),
    ],
    [
      (eq, "$duel", 2),
      (get_player_agent_no, ":var0"),
      (try_begin),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (gt, ":var1", -1),
        (display_message, "@You infringed the duel rules!"),
        (call_script, "script_change_troop_renown", "trp_player", -5),
        (call_script, "script_change_player_honor", -5),
        (set_party_battle_mode),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (eq, ":var3", "$duel_partner"),
          (agent_set_team, ":var2", 1),
        (try_end),
        (assign, "$duel", 1),
      (else_try),
        (try_for_agents, ":var4"),
          (agent_get_troop_id, ":var5", ":var4"),
          (eq, ":var5", "$duel_partner"),
          (agent_get_position, pos1, ":var4"),
          (agent_get_position, pos2, ":var0"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (is_between, ":var6", 800, 1600),
          (agent_get_horse, ":var7", ":var0"),
          (eq, ":var7", -1),
          (assign, "$duel", 3),
          (assign, "$countdown_to_duel", 10),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$duel", 3),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (gt, ":var1", -1),
        (display_message, "@You infringed the duel rules!"),
        (call_script, "script_change_troop_renown", "trp_player", -5),
        (call_script, "script_change_player_honor", -5),
        (set_party_battle_mode),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (eq, ":var3", "$duel_partner"),
          (agent_set_team, ":var2", 1),
        (try_end),
        (assign, "$duel", 1),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 10),
        (dialog_box, "@Leave your gun in the holster. Wait until the the bell rings and pull your gun.", "@duel"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 9),
        (play_sound, "snd_duel"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 1),
        (set_party_battle_mode),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (eq, ":var3", "$duel_partner"),
          (agent_set_team, ":var2", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, "$countdown_to_duel", 0),
        (play_sound, "snd_clocktick"),
      (else_try),
        (play_sound, "snd_Bell"),
        (assign, "$duel", 1),
      (try_end),
      (val_sub, "$countdown_to_duel", 1),
    ]),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0", "$current_town"),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (store_current_scene, ":var0"),
        (scene_set_slot, ":var0", 0, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_init_saloon_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (call_script, "script_override_unuseable_items_sub", "trp_player"),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (eq, "$g_mt_mode", 2),
        (display_message, "str_cant_use_inventory_town_hostile"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance", 2),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
      (call_script, "script_tick_saloon_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("village_center", 0, -1,
  "village center",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", 65536),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (call_script, "script_override_unuseable_items_sub", "trp_player"),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
        (assign, ":var0", "qst_hunt_down_fugitive"),
      (else_try),
        (check_quest_active, "qst_wanted_fugitive"),
        (neg|check_quest_succeeded, "qst_wanted_fugitive"),
        (neg|check_quest_failed, "qst_wanted_fugitive"),
        (quest_slot_eq, "qst_wanted_fugitive", 11, 1),
        (assign, ":var0", "qst_wanted_fugitive"),
      (try_end),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (call_script, "script_get_correct_fugitive_troop_to_reg0"),
          (assign, ":var1", reg0),
          (call_script, "script_cf_troop_agent_is_alive", ":var1"),
          (call_script, "script_fail_quest", ":var0"),
        (else_try),
          (call_script, "script_succeed_quest", ":var0"),
        (try_end),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (1, 0, ti_once, 
    [
      (assign, "$active_fugitive_quest_start", 0),
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
        (assign, "$active_fugitive_quest_start", "qst_hunt_down_fugitive"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_wanted_fugitive"),
        (neg|check_quest_succeeded, "qst_wanted_fugitive"),
        (neg|check_quest_failed, "qst_wanted_fugitive"),
        (quest_slot_eq, "qst_wanted_fugitive", 11, 1),
        (assign, "$active_fugitive_quest_start", "qst_wanted_fugitive"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (gt, "$active_fugitive_quest_start", 0),
        (try_begin),
          (call_script, "script_get_correct_fugitive_troop_to_reg0"),
          (assign, ":var1", reg0),
          (call_script, "script_cf_troop_agent_is_alive", ":var1"),
        (else_try),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest", "$active_fugitive_quest_start"),
        (quest_set_slot, "$active_fugitive_quest_start", 11, 0),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_succeed_quest", "$active_fugitive_quest_start"),
        (quest_set_slot, "$active_fugitive_quest_start", 11, 0),
      (try_end),
    ]),

    (0.1, 0, 0, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 2),
        (assign, ":var0", "qst_hunt_down_fugitive"),
      (else_try),
        (quest_slot_eq, "qst_wanted_fugitive", 11, 2),
        (assign, ":var0", "qst_wanted_fugitive"),
      (try_end),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (val_add, "$fugitive_duel_reminder_count", 1),
          (store_mod, ":var1", "$fugitive_duel_reminder_count", 50),
          (this_or_next|eq, "$fugitive_duel_reminder_count", 1),
          (eq, ":var1", 0),
          (play_track, "track_wind", 1),
          (dialog_box, "@You are participating in a duel. Leave your gun in the holster, dismount and step 8 meters away from your enemy.", "@Duel!"),
        (else_try),
          (get_player_agent_no, ":var2"),
          (try_for_agents, ":var3"),
            (agent_get_troop_id, ":var4", ":var3"),
            (call_script, "script_get_correct_fugitive_troop_to_reg0"),
            (assign, ":var5", reg0),
            (eq, ":var4", ":var5"),
            (agent_get_position, pos1, ":var3"),
          (try_end),
          (agent_get_position, pos2, ":var2"),
          (get_distance_between_positions, ":var6", pos1, pos2),
          (is_between, ":var6", 800, 1600),
          (agent_get_horse, ":var7", ":var2"),
          (eq, ":var7", -1),
          (quest_set_slot, ":var0", 11, 3),
          (assign, "$countdown_to_duel", 100),
        (else_try),
          (call_script, "script_cf_fail_duel_if_rules_infringed", ":var0"),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (assign, "$active_fugitive_quest_state_3", 0),
      (try_begin),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 3),
        (assign, "$active_fugitive_quest_state_3", "qst_hunt_down_fugitive"),
      (else_try),
        (quest_slot_eq, "qst_wanted_fugitive", 11, 3),
        (assign, "$active_fugitive_quest_state_3", "qst_wanted_fugitive"),
      (try_end),
      (gt, "$active_fugitive_quest_state_3", 0),
    ],
    [
      (try_begin),
        (call_script, "script_cf_fail_duel_if_rules_infringed", "$active_fugitive_quest_state_3"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 100),
        (dialog_box, "@Leave your gun in the holster. Wait until the the bell rings and pull your gun.", "@Duel!"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 90),
        (play_sound, "snd_duel"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 10),
        (set_party_battle_mode),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (call_script, "script_get_correct_fugitive_troop_to_reg0"),
          (assign, ":var2", reg0),
          (eq, ":var1", ":var2"),
          (agent_set_team, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 0),
        (play_sound, "snd_Bell"),
        (quest_set_slot, "$active_fugitive_quest_state_3", 11, 1),
      (try_end),
      (val_sub, "$countdown_to_duel", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("bandits_at_night", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (agent_set_team, ":var0", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
    ]),

    (1, 4, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_town_bandits_failed"),
      (else_try),
        (jump_to_menu, "mnu_town_bandits_succeeded"),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("village_training", mtf_arena_fight, -1,
  "village training",
  [
    (2, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("visit_town_castle", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_require_civilian|af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (call_script, "script_override_unuseable_items_sub", "trp_player"),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("back_alley_kill_local_merchant", mtf_arena_fight, -1,
  "You enter the back alley",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 1),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var1", 0),
      (assign, ":var3", -1),
      (assign, ":var4", -1),
      (try_for_agents, ":var5"),
        (agent_get_troop_id, ":var6", ":var5"),
        (try_begin),
          (eq, ":var6", "trp_local_merchant"),
          (store_agent_hit_points, ":var1", ":var5"),
          (assign, ":var3", ":var5"),
        (else_try),
          (eq, ":var6", "trp_player"),
          (store_agent_hit_points, ":var2", ":var5"),
          (assign, ":var4", ":var5"),
        (try_end),
      (try_end),
      (ge, ":var4", 0),
      (ge, ":var3", 0),
      (agent_is_alive, ":var4"),
      (agent_is_alive, ":var3"),
      (is_between, ":var1", 1, 30),
      (gt, ":var2", 50),
      (start_mission_conversation, "trp_local_merchant"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_local_merchant"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_kill_local_merchant"),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -4),
        (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("back_alley_revolt", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 4, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    common_battle_init_banner,

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_collect_taxes_failed"),
      (finish_mission),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_collect_taxes_failed"),
      (else_try),
        (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("train_heist", mtf_battle_mode, -1,
  "You are doin' train job.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    common_battle_init_banner,

    (1, 0, 0, 
    [],
    [
      (store_mission_timer_a, reg10),
      (ge, reg10, 130),
      (jump_to_menu, "mnu_train_job_complete"),
      (finish_mission),
    ]),

    (0, 0, 0, 
    [
      (call_script, "script_cf_train_heist", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_train_heist2", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_train_heist3", 0),
    ],
    []),

    (1, 5, 0, 
    [
      (play_sound, "snd_Steam_Locomotive", 2),
    ],
    []),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_train_job_failed"),
      (finish_mission),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_train_job_failed"),
      (else_try),
        (jump_to_menu, "mnu_train_job_complete"),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("steamboat_heist", mtf_battle_mode, -1,
  "You are ambushed while riding Rio Grande on a steamboat.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    common_battle_init_banner,

    (1, 0, ti_once, 
    [
      (call_script, "script_cf_steamboat_heist", 0),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
      (assign, "$g_player_icon_state", 2),
      (party_set_flags, "p_main_party", 512, 1),
      (party_get_position, pos1, "p_main_party"),
      (store_random_in_range, ":var1", 25, 160),
      (map_get_water_position_around_position, pos2, pos1, ":var1"),
      (party_set_position, "p_main_party", pos2),
      (assign, "$g_main_ship_party", -1),
      (troop_remove_gold, "trp_player", 500),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (assign, "$g_player_icon_state", 2),
        (party_set_flags, "p_main_party", 512, 1),
        (party_get_position, pos1, "p_main_party"),
        (store_random_in_range, ":var0", 25, 160),
        (map_get_water_position_around_position, pos2, pos1, ":var0"),
        (party_set_position, "p_main_party", pos2),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission, 0),
      (else_try),
        (assign, "$g_player_icon_state", 2),
        (party_set_flags, "p_main_party", 512, 1),
        (party_get_position, pos1, "p_town_6"),
        (map_get_water_position_around_position, pos2, pos1, 10),
        (party_set_position, "p_main_party", pos2),
        (assign, "$g_main_ship_party", -1),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("steamboat_heist2", mtf_battle_mode, -1,
  "You are ambushed while riding Rio Grande on a steamboat.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    common_battle_init_banner,

    (1, 0, ti_once, 
    [
      (call_script, "script_cf_steamboat_heist", 0),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
      (assign, "$g_player_icon_state", 2),
      (party_set_flags, "p_main_party", 512, 1),
      (party_get_position, pos1, "p_main_party"),
      (store_random_in_range, ":var1", 25, 160),
      (map_get_water_position_around_position, pos2, pos1, ":var1"),
      (party_set_position, "p_main_party", pos2),
      (assign, "$g_main_ship_party", -1),
      (troop_remove_gold, "trp_player", 500),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (assign, "$g_player_icon_state", 2),
        (party_set_flags, "p_main_party", 512, 1),
        (party_get_position, pos1, "p_main_party"),
        (store_random_in_range, ":var0", 25, 160),
        (map_get_water_position_around_position, pos2, pos1, ":var0"),
        (party_set_position, "p_main_party", pos2),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission, 0),
      (else_try),
        (assign, "$g_player_icon_state", 2),
        (party_set_flags, "p_main_party", 512, 1),
        (party_get_position, pos1, "p_town_5"),
        (map_get_water_position_around_position, pos2, pos1, 17),
        (party_set_position, "p_main_party", pos2),
        (assign, "$g_main_ship_party", -1),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("steamboat_ambush", mtf_battle_mode, charge,
  "You are ambushed while riding Miss Beatrice to your destination.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 20, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
      (call_script, "script_transport_player"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (call_script, "script_transport_player"),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_transport_player"),
        (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("steamboat_ambush2", mtf_battle_mode, charge,
  "You are ambushed while riding Miss Beatrice to your destination.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 20, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 12, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
      (party_get_position, pos1, "p_town_5"),
      (map_get_land_position_around_position, pos2, pos1, 1),
      (rest_for_hours, 2, 4, 0),
      (party_set_position, "p_main_party", pos2),
      (troop_remove_gold, "trp_player", 500),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$pin_player_fallen", 1),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (party_get_position, pos1, "p_town_5"),
        (map_get_land_position_around_position, pos2, pos1, 1),
        (rest_for_hours, 2, 4, 0),
        (party_set_position, "p_main_party", pos2),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission, 0),
      (else_try),
        (party_get_position, pos1, "p_town_6"),
        (map_get_land_position_around_position, pos2, pos1, 1),
        (rest_for_hours, 2, 4, 0),
        (party_set_position, "p_main_party", pos2),
        (troop_remove_gold, "trp_player", 500),
        (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("hideout", mtf_battle_mode, -1,
  "You found a bandit hideout.",
  [
    (0, mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_hideout"),
        (party_set_flags, "p_target", 256, 1),
      (else_try),
        (call_script, "script_succeed_quest", "qst_hideout"),
        (party_set_flags, "p_target", 256, 1),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("hideout2", mtf_battle_mode, -1,
  "You found a bandit hideout.",
  [
    (0, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    common_battle_init_banner,

    (ti_before_mission_start, 0, 0, 
    [
      (assign, "$art_time", 0),
    ],
    []),

    (1, 0, 0, 
    [
      (val_add, "$art_time", 1),
      (val_mod, "$art_time", 10),
      (store_sub, ":var0", "$art_time", 1),
      (val_mod, ":var0", 10),
      (try_for_range, ":var1", 0, 4),
        (store_add, ":var2", ":var1", "spr_cannon_a"),
        (store_add, ":var3", ":var1", "spr_cannon_a_target"),
        (scene_prop_get_num_instances, ":var4", ":var2"),
        (scene_prop_get_num_instances, ":var5", ":var3"),
        (gt, ":var5", 0),
        (try_for_range, ":var6", 0, ":var4"),
          (scene_prop_get_instance, ":var7", ":var2", ":var6"),
          (store_random_in_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", ":var3", ":var8"),
          (assign, ":var10", ":var7"),
          (val_mod, ":var10", 10),
          (try_begin),
            (eq, ":var10", "$art_time"),
            (prop_instance_get_position, pos1, ":var7"),
            (particle_system_burst, "psys_cannon_smoke", pos1, 10),
            (store_random_in_range, reg1, 0, 4),
            (val_add, reg1, "snd_cannon_shot1"),
            (play_sound, reg1),
          (try_end),
          (try_begin),
            (eq, ":var10", ":var0"),
            (prop_instance_get_position, pos1, ":var9"),
            (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var11", 0, 5),
        (store_add, ":var12", ":var11", "spr_cannon_target_no_source_10s"),
        (scene_prop_get_instance, ":var9", ":var12", ":var6"),
        (try_begin),
          (eq, ":var10", "$art_time"),
          (prop_instance_get_position, pos1, ":var9"),
          (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
        (try_end),
      (try_end),
    ],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (call_script, "script_fail_quest", "qst_hideout2"),
      (party_set_flags, "p_target", 256, 1),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
      (set_party_battle_mode),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_hideout2"),
        (party_set_flags, "p_target", 256, 1),
      (else_try),
        (call_script, "script_succeed_quest", "qst_hideout2"),
        (party_set_flags, "p_target", 256, 1),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("lead_charge", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (1, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 12, []),
    (0, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 12, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (1, 0, 0, 
    [],
    [
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neg|agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (try_for_agents, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var4", ":var1"),
        (teams_are_enemies, ":var4", ":var3"),
        (agent_get_combat_state, ":var5", ":var1"),
        (try_begin),
          (eq, ":var5", 7),
          (agent_ai_set_always_attack_in_melee, ":var1", 1),
        (else_try),
          (agent_ai_set_always_attack_in_melee, ":var1", 0),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (eq, 0, 1),
    ],
    [
      (assign, "$last_random_prop", "spr_random_prop_0"),
      (try_for_range, ":var0", "spr_skeleton_cow", "spr_scene_props_end"),
        (troop_get_slot, ":var1", "trp_prop_chance_to_appear", ":var0"),
        (store_mul, ":var2", ":var1", -1),
        (store_random_in_range, ":var3", ":var2", ":var1"),
        (val_add, ":var1", ":var3"),
        (try_for_range, ":var4", 0, ":var1"),
          (replace_scene_props, "$last_random_prop", ":var0"),
          (val_add, "$last_random_prop", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
    ],
    [
      (try_for_range, ":var0", "spr_skeleton_cow", "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var1", ":var0"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", ":var0", ":var2"),
          (get_scene_boundaries, pos2, pos3),
          (position_transform_position_to_local, pos4, pos2, pos3),
          (position_get_x, ":var4", pos4),
          (position_get_y, ":var5", pos4),
          (store_random_in_range, ":var6", 0, ":var4"),
          (store_random_in_range, ":var7", 0, ":var5"),
          (init_position, pos1),
          (position_set_x, pos1, ":var6"),
          (position_set_y, pos1, ":var7"),
          (position_set_z, pos1, 10000),
          (position_set_z_to_ground_level, pos1),
          (prop_instance_set_position, ":var3", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    common_battle_init_banner,

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 7),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 7),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
    ],
    [
      (call_script, "script_select_battle_tactic"),
      (call_script, "script_battle_tactic_init"),
    ]),

    (5, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 3),
      (call_script, "script_battle_tactic_apply"),
    ],
    []),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("village_attack_bandits", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 7, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 29),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("village_raid", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 12, []),
    (3, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 12, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 0, 6),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 2),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 3, 6),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$g_village_raid_evil", 0),
        (call_script, "script_play_victorious_sound"),
      (else_try),
        (play_track, "track_As_the_Dust_Settles", 1),
      (try_end),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("besiege_inner_battle_castle", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("besiege_inner_battle_town_center", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (2, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("castle_attack_walls_defenders_sally", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 12, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("castle_attack_walls_belfry", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (team_give_order, "$defender_team", 0, 0),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 10, pos10),
      (team_give_order, "$defender_team_2", 0, 0),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 10, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", 7),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 10),
      (add_reinforcements_to_entry, 4, 7),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 10, 2),
        (team_give_order, "$defender_team_2", 10, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 5),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 1, 8),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("castle_attack_walls_ladder", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (team_give_order, "$defender_team", 0, 0),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 10, pos10),
      (team_give_order, "$defender_team_2", 0, 0),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 10, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", 7),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 10),
      (add_reinforcements_to_entry, 4, 7),
      (val_add, "$defender_reinforcement_stage", 1),
      (try_begin),
        (ge, "$defender_reinforcement_stage", 2),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 0, 2),
        (team_give_order, "$defender_team_2", 0, 2),
        (set_show_messages, 1),
        (ge, "$defender_reinforcement_stage", 4),
        (set_show_messages, 0),
        (team_give_order, "$defender_team", 10, 2),
        (team_give_order, "$defender_team_2", 10, 2),
        (set_show_messages, 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 5),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 1, 8),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("castle_visit", 0, -1,
  "Castle visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (0, 0, ti_once, 
    [],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("training_ground_trainer_talk", 0, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (0, 1, 2, 
    [
      (lt, "$trainer_help_message", 2),
    ],
    [
      (try_begin),
        (eq, "$trainer_help_message", 0),
        (dialog_box, "str_trainer_help_1", "@Tutorial"),
      (else_try),
        (dialog_box, "str_trainer_help_2", "@Tutorial"),
      (try_end),
      (val_add, "$trainer_help_message", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("training_ground_trainer_training", mtf_arena_fight, -1,
  "You will fight a match in the arena.",
  [
    (16, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_native_shield_a,itm_gunclub,itm_native_body_warpaint]),
    (17, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_native_body_warpaint]),
    (18, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_native_body_warpaint]),
    (19, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_2by4,itm_native_body_warpaint]),
    (20, mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 1),
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (assign, "$training_fight_won", 1),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("training_ground_training", mtf_arena_fight, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (1, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (2, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff]),
    (8, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_last_destroyed_gourds", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_training_ground_training_success_ratio", 0),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos1, 0),
        (init_position, pos2),
        (position_set_y, pos2, "$g_training_ground_ranged_distance"),
        (position_transform_position_to_parent, pos3, pos1, pos2),
        (copy_position, pos1, pos3),
        (assign, ":var0", 10),
        (assign, ":var1", 0),
        (try_for_range, ":var2", 0, ":var0"),
          (store_sub, ":var3", ":var2", ":var1"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
          (copy_position, pos2, pos1),
          (init_position, pos0),
          (store_random_in_range, ":var5", 0, 360),
          (position_rotate_z, pos2, ":var5"),
          (store_random_in_range, ":var5", 50, 600),
          (position_move_x, pos2, ":var5"),
          (store_random_in_range, ":var5", 0, 360),
          (position_transform_position_to_local, pos3, pos1, pos2),
          (position_rotate_z, pos0, ":var5"),
          (position_transform_position_to_parent, pos4, pos0, pos3),
          (position_transform_position_to_parent, pos2, pos1, pos4),
          (position_set_z_to_ground_level, pos2),
          (position_move_z, pos2, 150),
          (assign, ":var6", 1),
          (try_for_range, ":var7", 0, 10),
            (eq, ":var6", 1),
            (neq, ":var3", ":var7"),
            (scene_prop_get_instance, ":var8", "spr_gourd", ":var7"),
            (prop_instance_get_position, pos3, ":var8"),
            (get_distance_between_positions, ":var9", pos2, pos3),
            (lt, ":var9", 100),
            (assign, ":var6", 0),
          (try_end),
          (try_begin),
            (eq, ":var6", 0),
            (val_add, ":var0", 1),
            (val_add, ":var1", 1),
          (else_try),
            (prop_instance_set_position, ":var4", pos2),
            (prop_instance_animate_to_position, ":var4", pos2, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var3"),
            (position_move_z, pos2, -150),
            (prop_instance_set_position, ":var8", pos2),
            (prop_instance_animate_to_position, ":var8", pos2, 1),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$g_mt_mode", 3),
        (assign, ":var10", 0),
        (try_for_range, ":var2", 0, 100),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var2"),
          (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var2"),
          (ge, ":var4", 0),
          (ge, ":var8", 0),
          (val_add, ":var10", 1),
          (prop_instance_get_position, pos0, ":var8"),
          (position_move_z, pos0, 150),
          (prop_instance_set_position, ":var4", pos0),
          (prop_instance_animate_to_position, ":var4", pos0, 1),
        (try_end),
        (store_sub, ":var0", ":var10", "$g_training_ground_training_num_gourds_to_destroy"),
        (try_for_range, ":var2", 0, ":var0"),
          (store_random_in_range, ":var11", 0, ":var10"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var11"),
          (prop_instance_get_position, pos0, ":var4"),
          (position_get_z, ":var12", pos0),
          (try_begin),
            (lt, ":var12", -50000),
            (val_add, ":var0", 1),
          (else_try),
            (position_set_z, pos0, -100000),
            (prop_instance_set_position, ":var4", pos0),
            (prop_instance_animate_to_position, ":var4", pos0, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var11"),
            (prop_instance_set_position, ":var8", pos0),
            (prop_instance_animate_to_position, ":var8", pos0, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_training_ground_training_success_ratio", 100),
      (else_try),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var2", ":var1"),
          (eq, ":var2", 1),
          (val_add, ":var0", 1),
        (try_end),
        (store_sub, ":var3", "$g_training_ground_training_num_enemies", ":var0"),
        (store_mul, "$g_training_ground_training_success_ratio", ":var3", 100),
        (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
      (try_end),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_ammo, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|main_hero_fallen),
      (this_or_next|eq, ":var1", 0),
      (gt, ":var2", 116),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (get_player_agent_no, ":var0"),
      (agent_get_horse, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|lt, ":var1", 0),
      (this_or_next|main_hero_fallen),
      (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
      (gt, ":var2", 120),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
      (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (0, 0, 0, 
    [
      (gt, "$g_last_destroyed_gourds", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (entry_point_get_position, pos1, 0),
        (position_move_y, pos1, 100, 0),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos2, ":var0"),
        (try_begin),
          (position_is_behind_position, pos2, pos1),
          (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
        (else_try),
          (display_message, "@You must stay behind the line on the ground! Point is not counted."),
        (try_end),
      (else_try),
        (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
      (try_end),
      (assign, "$g_last_destroyed_gourds", 0),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("sneak_caught_fight", mtf_arena_fight, -1,
  "You must fight your way out!",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_wish_to_surrender"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sneak_town_halt"),
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 3, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (5, 1, ti_once, 
    [
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
    ],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (finish_mission, 1),
    ]),

    (ti_on_leave_area, 0, ti_once, 
    [],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("ai_training", 0, -1,
  "You start training.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_presentation_battle_active", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("camera_test", 0, -1,
  "camera Test.",
  [
  ],
  [
    (1, 0, 0, 
    [
      (mission_cam_set_mode, 1),
      (entry_point_get_position, pos3, 3),
      (mission_cam_set_position, pos3),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("arena_melee_fight", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (1, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_red]),
    (2, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (3, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (4, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_arena_tunic_red]),
    (5, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_red]),
    (6, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_red]),
    (7, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_red,itm_red_tourney_helmet]),
    (8, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_arena_tunic_blue]),
    (9, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (10, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (11, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (12, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_blue]),
    (13, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_blue,itm_blue_tourney_helmet]),
    (14, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_blue]),
    (15, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_blue]),
    (16, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (17, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (18, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (19, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (20, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (21, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_green]),
    (22, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_green]),
    (23, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_green,itm_green_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (25, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (26, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (27, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (28, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (29, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (30, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (31, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (32, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (33, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (34, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (35, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (36, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (37, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (38, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (39, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse,itm_arena_tunic_yellow]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse,itm_arena_tunic_yellow,itm_gold_tourney_helmet]),
    (50, mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (51, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (52, mtef_scene_source, af_override_horse, 0, 1, []),
    (53, mtef_scene_source, af_override_horse, 0, 1, []),
    (54, mtef_scene_source, af_override_horse, 0, 1, []),
    (55, mtef_scene_source, af_override_horse, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_fur_coat,itm_fur_hat]),
    (57, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_fur_coat,itm_fur_hat]),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (call_script, "script_end_tournament_fight", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (call_script, "script_end_tournament_fight", 0),
        (finish_mission),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 40),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (set_visitor, 35, "trp_veteran_fighter"),
      (set_visitor, 36, "trp_veteran_fighter"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 7),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 6),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 6),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 32, 40),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 14),
      (store_div, ":var9", ":var7", 3),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (store_random_in_range, ":var4", 0, ":var0"),
          (try_for_range, ":var5", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var5", 0),
          (try_end),
          (try_for_agents, ":var6"),
            (agent_is_human, ":var6"),
            (agent_is_alive, ":var6"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var6", 7, 1),
            (agent_get_team, ":var7", ":var6"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var7"),
            (val_add, ":var8", 1),
            (troop_set_slot, "trp_temp_array_a", ":var7", ":var8"),
          (try_end),
          (assign, ":var9", 0),
          (troop_get_slot, ":var10", "trp_temp_array_a", 0),
          (try_for_range, ":var5", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var5", ":var10"),
            (troop_get_slot, ":var10", "trp_temp_array_a", ":var5"),
            (assign, ":var9", ":var5"),
          (try_end),
          (store_random_in_range, ":var11", 5, 100),
          (try_begin),
            (lt, ":var11", "$g_arena_training_num_agents_spawned"),
            (assign, ":var4", ":var9"),
          (try_end),
          (agent_set_team, ":var2", ":var4"),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("arena_challenge_fight", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "@Cannot leave now."),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (try_end),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_1", 0, -1,
  "You enter the training ground.",
  [
    (0, mtef_no_companions|mtef_no_regulars, af_override_weapons|af_override_horse, 0, 1, [itm_tutorial_shield,itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_1_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_1_state", 0),
      (assign, "$tutorial_1_msg_1_displayed", 0),
      (assign, "$tutorial_1_msg_2_displayed", 0),
      (assign, "$tutorial_1_msg_3_displayed", 0),
      (assign, "$tutorial_1_msg_4_displayed", 0),
      (assign, "$tutorial_1_msg_5_displayed", 0),
      (assign, "$tutorial_1_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_1_state", 0),
        (try_begin),
          (eq, "$tutorial_1_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_1_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_1"),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (entry_point_get_position, pos1, 1),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (tutorial_message, "str_tutorial_1_msg_1"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 2),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 1),
        (try_begin),
          (eq, "$tutorial_1_msg_2_displayed", 0),
          (assign, "$tutorial_1_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 3),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 2),
        (try_begin),
          (eq, "$tutorial_1_msg_3_displayed", 0),
          (assign, "$tutorial_1_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_3"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 4),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
      (else_try),
        (eq, "$tutorial_1_state", 3),
        (try_begin),
          (eq, "$tutorial_1_msg_4_displayed", 0),
          (assign, "$tutorial_1_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_4"),
          (store_mission_timer_a, "$tutorial_time"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (gt, ":var0", 10),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 4),
        (try_begin),
          (eq, "$tutorial_1_msg_5_displayed", 0),
          (assign, "$tutorial_1_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_5"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var2"),
          (agent_get_ammo, ":var5", ":var2"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var2"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 5),
        (eq, "$tutorial_1_msg_6_displayed", 0),
        (assign, "$tutorial_1_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_1_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_1_finished", 1),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_weapons|af_override_horse, 0, 1, [itm_tutorial_shield]),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_2_state", 9),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_2_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_2_state", 0),
      (assign, "$tutorial_2_msg_1_displayed", 0),
      (assign, "$tutorial_2_msg_2_displayed", 0),
      (assign, "$tutorial_2_msg_3_displayed", 0),
      (assign, "$tutorial_2_msg_4_displayed", 0),
      (assign, "$tutorial_2_msg_5_displayed", 0),
      (assign, "$tutorial_2_msg_6_displayed", 0),
      (assign, "$tutorial_2_msg_7_displayed", 0),
      (assign, "$tutorial_2_msg_8_displayed", 0),
      (assign, "$tutorial_2_msg_9_displayed", 0),
      (assign, "$tutorial_2_melee_agent_state", 0),
    ],
    []),

    (10, 0, 0, 
    [
      (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
      (agent_refill_ammo, reg0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_2_state", 0),
        (try_begin),
          (eq, "$tutorial_2_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_2_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_1"),
          (team_give_order, 1, 10, 11),
          (team_give_order, 1, 0, 2),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 1),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 2),
        (try_begin),
          (eq, "$tutorial_2_melee_agent_state", 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (agent_clear_scripted_mode, ":var1"),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (store_mission_timer_a, "$tutorial_time"),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 2),
          (try_begin),
            (eq, "$tutorial_2_msg_2_displayed", 0),
            (assign, "$tutorial_2_msg_2_displayed", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (store_mission_timer_a, ":var0"),
          (val_sub, ":var0", "$tutorial_time"),
          (store_sub, reg3, 20, ":var0"),
          (tutorial_message, "str_tutorial_2_msg_2"),
          (gt, ":var0", 20),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 3),
          (try_begin),
            (eq, "$tutorial_2_msg_3_displayed", 0),
            (assign, "$tutorial_2_msg_3_displayed", 1),
            (tutorial_message, "str_tutorial_2_msg_3"),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 2),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 4),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 2),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 30),
          (agent_set_position, ":var1", pos1),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
          (prop_instance_get_position, pos1, ":var4"),
          (position_rotate_z, pos1, 90),
          (prop_instance_animate_to_position, ":var4", pos1, 150),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (val_add, "$tutorial_2_state", 1),
        (try_end),
      (else_try),
        (eq, "$tutorial_2_state", 3),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (store_mission_timer_a, "$tutorial_time"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 4),
        (try_begin),
          (eq, "$tutorial_2_msg_4_displayed", 0),
          (assign, "$tutorial_2_msg_4_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_2_msg_4"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 5),
        (set_spawn_position, pos1),
        (spawn_item, "itm_tutorial_sword"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_set_position, ":var1", pos1),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 5),
        (try_begin),
          (eq, "$tutorial_2_msg_5_displayed", 0),
          (assign, "$tutorial_2_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 2),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 6),
        (try_begin),
          (eq, "$tutorial_2_msg_6_displayed", 0),
          (assign, "$tutorial_2_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_has_item_equipped, ":var2", "itm_tutorial_sword"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 7),
        (try_begin),
          (eq, "$tutorial_2_msg_7_displayed", 0),
          (assign, "$tutorial_2_msg_7_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_7"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (agent_clear_scripted_mode, ":var1"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 4),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 8),
        (try_begin),
          (eq, "$tutorial_2_msg_8_displayed", 0),
          (assign, "$tutorial_2_msg_8_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_8"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 9),
        (eq, "$tutorial_2_msg_9_displayed", 0),
        (assign, "$tutorial_2_msg_9_displayed", 1),
        (tutorial_message, "str_tutorial_2_msg_9"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_2_finished", 1),
      (else_try),
        (gt, "$tutorial_2_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_3", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_weapons|af_override_horse, 0, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 12),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
      (assign, "$tutorial_3_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_item, "itm_tutorial_staff_no_attack"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_has_item_equipped, ":var2", "itm_tutorial_staff_no_attack"),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 30, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_3"),
        (gt, ":var0", 30),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 6),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 3),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 7),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 8),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 9),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 10),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 11),
        (try_begin),
          (eq, "$tutorial_3_msg_5_displayed", 0),
          (assign, "$tutorial_3_msg_5_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 30, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_5"),
        (gt, ":var0", 30),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 12),
        (try_begin),
          (eq, "$tutorial_3_msg_6_displayed", 0),
          (assign, "$tutorial_3_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 5),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 13),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 5),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_3_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_weapons|af_override_horse, 0, 1, [itm_tutorial_staff]),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_1"),
          (play_sound, "snd_tutorial_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (neg|agent_is_alive, reg0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (neg|agent_is_alive, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (eq, "$tutorial_3_msg_5_displayed", 0),
        (assign, "$tutorial_3_msg_5_displayed", 1),
        (tutorial_message, "str_tutorial_3_2_msg_5"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_3_finished", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_4", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_weapons|af_override_horse, 0, 1, [itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_4_state", 11),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_4_state", 0),
      (assign, "$tutorial_4_msg_1_displayed", 0),
      (assign, "$tutorial_4_msg_2_displayed", 0),
      (assign, "$tutorial_4_msg_3_displayed", 0),
      (assign, "$tutorial_4_msg_4_displayed", 0),
      (assign, "$tutorial_4_msg_5_displayed", 0),
      (assign, "$tutorial_4_msg_6_displayed", 0),
      (assign, "$tutorial_4_msg_7_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_4_state", 0),
        (try_begin),
          (eq, "$tutorial_4_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_4_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_1"),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_horse, "itm_tutorial_saddle_horse"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (ge, ":var2", 0),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 2),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 1),
        (try_begin),
          (eq, "$tutorial_4_msg_2_displayed", 0),
          (assign, "$tutorial_4_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 3),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 2),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 3),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 4),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 3),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 4),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 5),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 4),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 5),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 1),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 6),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 7),
        (try_begin),
          (eq, "$tutorial_4_msg_3_displayed", 0),
          (assign, "$tutorial_4_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 8),
        (try_begin),
          (eq, "$tutorial_4_msg_4_displayed", 0),
          (assign, "$tutorial_4_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 2),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 8),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 9),
        (try_begin),
          (eq, "$tutorial_4_msg_5_displayed", 0),
          (assign, "$tutorial_4_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 8),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 10),
        (try_begin),
          (eq, "$tutorial_4_msg_6_displayed", 0),
          (assign, "$tutorial_4_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_6"),
          (play_sound, "snd_tutorial_1"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var1"),
          (agent_get_ammo, ":var5", ":var1"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var1"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_4_state", 1),
      (else_try),
        (eq, "$tutorial_4_state", 11),
        (eq, "$tutorial_4_msg_7_displayed", 0),
        (assign, "$tutorial_4_msg_7_displayed", 1),
        (tutorial_message, "str_tutorial_4_msg_7"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_4_finished", 1),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tutorial_5", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, 0, 1, [itm_tutorial_sword,itm_tutorial_shield,itm_tutorial_short_bow,itm_tutorial_arrows,itm_tutorial_saddle_horse]),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_5_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_5_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (assign, "$tutorial_5_state", 0),
      (assign, "$tutorial_5_msg_1_displayed", 0),
      (assign, "$tutorial_5_msg_2_displayed", 0),
      (assign, "$tutorial_5_msg_3_displayed", 0),
      (assign, "$tutorial_5_msg_4_displayed", 0),
      (assign, "$tutorial_5_msg_5_displayed", 0),
      (assign, "$tutorial_5_msg_6_displayed", 0),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, 0, 10, 11),
      (set_show_messages, 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_5_state", 0),
        (try_begin),
          (eq, "$tutorial_5_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_5_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_1"),
          (entry_point_get_position, pos1, 5),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 1),
        (try_begin),
          (eq, "$tutorial_5_msg_2_displayed", 0),
          (assign, "$tutorial_5_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 2),
        (try_begin),
          (eq, "$tutorial_5_msg_3_displayed", 0),
          (assign, "$tutorial_5_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (entry_point_get_position, pos1, 11),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 12),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (set_show_messages, 0),
        (team_give_order, 0, 1, 11),
        (set_show_messages, 1),
      (else_try),
        (eq, "$tutorial_5_state", 3),
        (try_begin),
          (eq, "$tutorial_5_msg_4_displayed", 0),
          (assign, "$tutorial_5_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 1),
        (entry_point_get_position, pos2, 11),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 12),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 8, "trp_looter_2"),
        (set_visitor, 9, "trp_looter_2"),
        (set_visitor, 10, "trp_looter_2"),
        (set_visitor, 11, "trp_looter_2"),
        (team_give_order, 1, 10, 2),
      (else_try),
        (eq, "$tutorial_5_state", 4),
        (try_begin),
          (eq, "$tutorial_5_msg_5_displayed", 0),
          (assign, "$tutorial_5_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (assign, ":var4", 0),
        (try_for_agents, ":var5"),
          (agent_is_human, ":var5"),
          (agent_is_alive, ":var5"),
          (agent_get_team, ":var6", ":var5"),
          (eq, ":var6", 1),
          (val_add, ":var4", 1),
        (try_end),
        (eq, ":var4", 0),
        (val_add, "$tutorial_5_state", 1),
      (else_try),
        (eq, "$tutorial_5_state", 5),
        (eq, "$tutorial_5_msg_6_displayed", 0),
        (assign, "$tutorial_5_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_5_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_5_finished", 1),
      (else_try),
        (gt, "$tutorial_5_state", 30),
        (tutorial_message, "str_tutorial_failed"),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("custom_battle", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (15, 0, ti_once, 
    [],
    [
      (call_script, "script_cf_team_charge_if_ammo_le_percent", 1, 25),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (assign, "$art_time", 0),
    ],
    []),

    common_battle_init_banner,

    (1, 0, 0, 
    [],
    [
      (val_add, "$art_time", 1),
      (val_mod, "$art_time", 10),
      (store_sub, ":var0", "$art_time", 1),
      (val_mod, ":var0", 10),
      (try_for_range, ":var1", 0, 4),
        (store_add, ":var2", ":var1", "spr_cannon_a"),
        (store_add, ":var3", ":var1", "spr_cannon_a_target"),
        (scene_prop_get_num_instances, ":var4", ":var2"),
        (scene_prop_get_num_instances, ":var5", ":var3"),
        (gt, ":var5", 0),
        (try_for_range, ":var6", 0, ":var4"),
          (scene_prop_get_instance, ":var7", ":var2", ":var6"),
          (store_random_in_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", ":var3", ":var8"),
          (assign, ":var10", ":var7"),
          (val_mod, ":var10", 10),
          (try_begin),
            (eq, ":var10", "$art_time"),
            (prop_instance_get_position, pos1, ":var7"),
            (particle_system_burst, "psys_cannon_smoke", pos1, 10),
            (call_script, "script_cannon_fire_sound", 1),
            (position_move_y, pos1, -200),
            (prop_instance_animate_to_position, ":var7", pos1, 20),
          (try_end),
          (try_begin),
            (eq, ":var10", ":var0"),
            (prop_instance_get_position, pos1, ":var7"),
            (position_move_y, pos1, 200),
            (prop_instance_animate_to_position, ":var7", pos1, 200),
            (prop_instance_get_position, pos1, ":var9"),
            (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var11", 0, 5),
        (store_add, ":var12", ":var11", "spr_cannon_target_no_source_10s"),
        (scene_prop_get_num_instances, ":var5", ":var12"),
        (try_for_range, ":var6", 0, ":var5"),
          (store_mul, ":var13", ":var11", 5),
          (val_add, ":var13", 10),
          (store_random_in_range, ":var14", 0, ":var13"),
          (le, ":var14", 6),
          (scene_prop_get_instance, ":var9", ":var12", ":var6"),
          (assign, ":var10", ":var9"),
          (val_mod, ":var10", 10),
          (try_begin),
            (eq, ":var10", "$art_time"),
            (prop_instance_get_position, pos1, ":var9"),
            (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_team_0_position"),
      (scene_prop_get_num_instances, ":var1", "spr_team_1_position"),
      (try_begin),
        (gt, ":var0", 0),
        (scene_prop_get_instance, ":var2", "spr_team_0_position", 0),
        (prop_instance_get_position, pos1, ":var2"),
        (team_give_order, 0, 10, 0),
        (team_set_order_position, 0, 10, pos1),
      (try_end),
      (try_begin),
        (gt, ":var1", 0),
        (scene_prop_get_instance, ":var2", "spr_team_1_position", 0),
        (prop_instance_get_position, pos1, ":var2"),
        (team_give_order, 1, 10, 0),
        (team_set_order_position, 1, 10, pos1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_before_mission_start, 
    [],
    [
      (team_set_relation, 0, 5, 1),
      (team_set_relation, 1, 5, 1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("custom_battle_siege", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (team_give_order, "$defender_team", 0, 0),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 10, pos10),
      (team_give_order, "$defender_team_2", 0, 0),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 10, pos10),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("custom_battle_5", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 1),
      (assign, "$attacker_team", 0),
      (assign, "$defender_team_2", 3),
      (assign, "$attacker_team_2", 2),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (team_give_order, "$defender_team", 0, 0),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 10, pos10),
      (team_give_order, "$defender_team_2", 0, 0),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 10, pos10),
      (set_show_messages, 1),
    ],
    []),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    []),

    (0, 2, ti_once, 
    [
      (call_script, "script_cf_siege_rotate_belfry_platform"),
    ],
    [
      (assign, "$belfry_positioned", 3),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("zombie_custom_battle", 0, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_4|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_4|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (4, 2, 2, 
    [
      (try_begin),
        (neg|key_is_down, key_u),
        (mission_cam_set_mode, 0),
      (try_end),
      (key_is_down, key_u),
      (mission_cam_get_position, pos1),
      (mission_cam_set_mode, 1),
      (mission_cam_set_position, pos1),
      (mission_cam_set_aperture, 100),
      (position_move_y, pos1, -100),
      (mission_cam_animate_to_position_and_aperture, pos1, 0, 2000, 0),
    ],
    [
      (mission_cam_get_position, pos1),
      (mission_cam_set_mode, 1),
      (position_move_y, pos1, 100),
      (mission_cam_animate_to_position_and_aperture, pos1, 100, 2000, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
      (team_set_relation, 0, 4, 0),
      (team_set_relation, 1, 4, 0),
      (team_set_relation, 2, 4, 0),
      (team_set_relation, 3, 4, 0),
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 0, 3, 1),
      (team_set_relation, 2, 3, 1),
      (get_player_agent_no, ":var0"),
      (team_set_leader, 3, ":var0"),
      (team_give_order, 3, 10, 1),
    ]),

    (0.5, 0, ti_once, 
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos1, ":var0"),
      (entry_point_get_position, pos2, 2),
      (get_distance_between_positions, ":var1", pos1, pos2),
      (lt, ":var1", 200),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_entry_no, ":var1", ":var0"),
        (try_begin),
          (eq, ":var1", 1),
          (agent_set_team, ":var0", 2),
        (else_try),
          (eq, ":var1", 22),
          (agent_set_team, ":var0", 1),
        (try_end),
      (try_end),
      (entry_point_get_position, pos1, 1),
      (team_set_order_position, 2, 10, pos1),
      (team_give_order, 2, 10, 0),
    ]),

    (2, 0, ti_once, 
    [
      (assign, ":var0", 1),
      (try_for_agents, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_entry_no, ":var2", ":var1"),
        (eq, ":var2", 22),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_entry_no, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_get_troop_id, ":var2", ":var0"),
        (troop_get_type, ":var3", ":var2"),
        (neq, ":var3", 9),
        (neq, ":var3", 10),
        (agent_set_team, ":var0", 3),
      (try_end),
    ]),

    (10, 0, ti_once, 
    [
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (troop_get_type, ":var3", ":var2"),
        (this_or_next|eq, ":var3", 9),
        (eq, ":var3", 10),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 2),
      (try_for_range, ":var4", 17, 21),
        (entry_point_get_position, pos1, ":var4"),
        (set_spawn_position, pos1),
        (try_for_range, ":var5", 0, "itm_end"),
          (troop_remove_items, "trp_qb_zombie", ":var5", 99),
        (try_end),
        (call_script, "script_equip_random_zombie_gear", "trp_qb_zombie"),
        (troop_set_type, "trp_qb_zombie", 9),
        (spawn_agent, "trp_qb_zombie"),
        (agent_set_team, reg0, 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [
      (try_for_range, ":var0", 16, 17),
        (entry_point_get_position, pos1, ":var0"),
        (set_spawn_position, pos1),
        (try_for_range, ":var1", 0, "itm_end"),
          (troop_remove_items, "trp_qb_zombie", ":var1", 99),
        (try_end),
        (call_script, "script_equip_random_zombie_gear", "trp_qb_zombie"),
        (troop_set_type, "trp_qb_zombie", 9),
        (spawn_agent, "trp_qb_zombie"),
        (agent_set_team, reg0, 1),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_get_type, ":var2", ":var1"),
        (eq, ":var2", 9),
        (try_begin),
          (agent_is_alive, ":var0"),
          (store_agent_hit_points, ":var3", ":var0"),
          (agent_get_slot, ":var4", ":var0", 6),
          (agent_set_slot, ":var0", 6, ":var3"),
          (val_sub, ":var4", ":var3"),
          (gt, ":var4", 50),
          (agent_get_position, pos1, ":var0"),
          (init_position, pos2),
          (agent_set_position, ":var0", pos2),
          (try_for_range, ":var5", 0, "itm_end"),
            (troop_remove_items, ":var1", ":var5", 99),
            (agent_has_item_equipped, ":var0", ":var5"),
            (item_get_type, ":var2", ":var5"),
            (neq, ":var2", 12),
            (troop_add_item, ":var1", ":var5"),
          (try_end),
          (troop_equip_items, ":var1"),
          (call_script, "script_dmod_kill_agent", ":var0"),
          (set_spawn_position, pos1),
          (troop_set_type, ":var1", 10),
          (spawn_agent, ":var1"),
          (agent_set_team, reg0, 1),
          (agent_set_hit_points, reg0, ":var3"),
          (agent_set_slot, ":var0", 7, 1),
          (agent_set_slot, reg0, 7, 0),
          (position_move_z, pos1, 180),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_get_troop_id, ":var2", ":var1"),
        (troop_get_type, ":var3", ":var2"),
        (neq, ":var3", 9),
        (neq, ":var3", 10),
        (try_begin),
          (agent_is_alive, ":var1"),
          (store_agent_hit_points, ":var4", ":var1"),
          (lt, ":var4", 30),
          (troop_get_type, ":var3", ":var2"),
          (neq, ":var3", 9),
          (neq, ":var3", 10),
          (agent_get_position, pos1, ":var1"),
          (init_position, pos2),
          (agent_set_position, ":var1", pos2),
          (try_for_range, ":var5", 0, "itm_end"),
            (troop_remove_items, ":var2", ":var5", 99),
            (agent_has_item_equipped, ":var1", ":var5"),
            (item_get_type, ":var3", ":var5"),
            (neq, ":var3", 12),
            (troop_add_item, "trp_qb_zombie", ":var5"),
          (try_end),
          (troop_equip_items, "trp_qb_zombie"),
          (set_spawn_position, pos1),
          (troop_set_type, "trp_qb_zombie", 9),
          (spawn_agent, "trp_qb_zombie"),
          (agent_set_team, reg0, 1),
          (agent_set_animation, reg0, "anim_unused_human_anim_6"),
          (set_show_messages, 0),
          (call_script, "script_dmod_kill_agent", ":var1"),
          (set_show_messages, 1),
        (try_end),
      (try_end),
    ],
    []),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("town_attack", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (48, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (49, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (47, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (47, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (47, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (replace_scene_props, "spr_battlement_a_destroyed", "spr_battlement_a"),
      (replace_scene_props, "spr_snowy_castle_battlement_a_destroyed", "spr_snowy_castle_battlement_a"),
      (replace_scene_props, "spr_castle_e_battlement_a_destroyed", "spr_castle_e_battlement_a"),
      (replace_scene_props, "spr_castle_battlement_a_destroyed", "spr_castle_battlement_a"),
      (replace_scene_props, "spr_castle_battlement_b_destroyed", "spr_castle_battlement_b"),
      (replace_scene_props, "spr_mangonel", "spr_empty"),
      (replace_scene_props, "spr_trebuchet_old", "spr_empty"),
      (replace_scene_props, "spr_trebuchet_new", "spr_empty"),
      (replace_scene_props, "spr_stone_ball", "spr_empty"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, "$battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, reg0, 1),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, reg0, 2),
        (display_message, "str_msg_battle_won"),
        (assign, "$battle_won", 1),
        (assign, "$g_battle_result", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 5, 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_count_mission_casualties_from_agents"),
        (set_mission_result, -1),
        (finish_mission, 0),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    common_battle_init_banner,

    (0, 0, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (team_give_order, 0, 10, 2),
      (team_give_order, 1, 10, 2),
      (team_give_order, 2, 10, 2),
      (team_give_order, 3, 10, 2),
      (assign, "$g_deathcam_battle_ended_loop_count", 0),
    ]),

    (0, 0, 0, 
    [
      (main_hero_fallen),
      (try_begin),
        (key_is_down, key_w),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_s),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_y, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_d),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, 10),
        (agent_set_position, ":var0", pos1),
      (try_end),
      (try_begin),
        (key_is_down, key_a),
        (get_player_agent_no, ":var0"),
        (agent_get_look_position, pos1, ":var0"),
        (position_move_x, pos1, -10),
        (agent_set_position, ":var0", pos1),
      (try_end),
    ],
    []),

    (0, 6, 0, 
    [
      (main_hero_fallen),
    ],
    [
      (call_script, "script_check_remaining_troop_conditions"),
      (try_begin),
        (eq, reg0, 1),
        (try_begin),
          (ge, "$g_deathcam_battle_ended_loop_count", 3),
          (assign, "$g_battle_result", -1),
          (set_mission_result, -1),
          (call_script, "script_count_mission_casualties_from_agents"),
          (finish_mission),
        (else_try),
          (val_add, "$g_deathcam_battle_ended_loop_count", 1),
        (try_end),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_presentation_battle_active", 0),
      (call_script, "script_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (team_give_order, "$defender_team", 0, 0),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 0, 7),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 10, pos10),
      (team_give_order, "$defender_team_2", 0, 0),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 0, 7),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 10, pos10),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 10, 0),
      (team_give_order, "$attacker_team", 10, 8),
      (team_give_order, "$attacker_team", 10, 8),
      (team_give_order, "$attacker_team", 10, 8),
      (team_give_order, "$attacker_team_2", 10, 0),
      (team_give_order, "$attacker_team_2", 10, 8),
      (team_give_order, "$attacker_team_2", 10, 8),
      (team_give_order, "$attacker_team_2", 10, 8),
      (set_show_messages, 1),
    ],
    []),

    (160, 0, ti_once, 
    [],
    [
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 10, 2),
      (team_give_order, "$attacker_team_2", 10, 2),
      (set_show_messages, 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (assign, "$art_time", 0),
    ],
    []),

    (1, 0, 0, 
    [],
    [
      (store_mission_timer_a, reg10),
      (le, reg10, 10),
      (val_add, "$art_time", 1),
      (val_mod, "$art_time", 10),
      (store_sub, ":var0", "$art_time", 1),
      (val_mod, ":var0", 10),
      (try_for_range, ":var1", 0, 4),
        (store_add, ":var2", ":var1", "spr_cannon_a"),
        (store_add, ":var3", ":var1", "spr_cannon_a_target"),
        (scene_prop_get_num_instances, ":var4", ":var2"),
        (scene_prop_get_num_instances, ":var5", ":var3"),
        (gt, ":var5", 0),
        (try_for_range, ":var6", 0, ":var4"),
          (scene_prop_get_instance, ":var7", ":var2", ":var6"),
          (store_random_in_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", ":var3", ":var8"),
          (assign, ":var10", ":var7"),
          (val_mod, ":var10", 10),
          (try_begin),
            (eq, ":var10", "$art_time"),
            (prop_instance_get_position, pos1, ":var7"),
            (particle_system_burst, "psys_cannon_smoke", pos1, 10),
            (store_random_in_range, reg1, 0, 4),
            (val_add, reg1, "snd_cannon_shot1"),
            (play_sound, reg1),
          (try_end),
          (try_begin),
            (eq, ":var10", ":var0"),
            (prop_instance_get_position, pos1, ":var9"),
            (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var11", 0, 5),
        (store_add, ":var12", ":var11", "spr_cannon_target_no_source_10s"),
        (scene_prop_get_instance, ":var9", ":var12", ":var6"),
        (try_begin),
          (eq, ":var10", "$art_time"),
          (prop_instance_get_position, pos1, ":var9"),
          (call_script, "script_explosion_at_pos1", 1000, 1000, -1),
        (try_end),
      (try_end),
    ]),

    (3, 0, 5, 
    [],
    [
      (lt, "$defender_reinforcement_stage", 7),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 10),
      (add_reinforcements_to_entry, 5, 1),
      (add_reinforcements_to_entry, 6, 1),
      (add_reinforcements_to_entry, 7, 1),
      (add_reinforcements_to_entry, 8, 1),
      (add_reinforcements_to_entry, 9, 1),
      (add_reinforcements_to_entry, 10, 1),
      (add_reinforcements_to_entry, 11, 1),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", 5),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 6),
    ],
    [
      (add_reinforcements_to_entry, 1, 8),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have fallen in battle, but your soldiers carry on the fight!"),
      (display_message, "@Press TAB at any time to force your remaining troops to retreat."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (eq, "$g_presentation_battle_active", 1),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("custom_battle_custom", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    common_battle_init_banner,

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (neg|main_hero_fallen, 0),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("graveyard_duel", 0, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_visitor_source, af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$duel", 5),
        (assign, "$auto_enter_town", "p_graveyard_1"),
        (finish_mission, 0),
        (assign, "$duel", 0),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$pre_duel_conversation", 1),
      (start_mission_conversation, "$duel_partner"),
    ]),

    (1, 10, ti_once, 
    [
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$duel_partner"),
      (else_try),
        (call_script, "script_cf_troop_agent_is_alive", "$duel_partner_b"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
      (try_begin),
        (main_hero_fallen),
        (try_begin),
          (quest_slot_eq, "qst_graveyard_duel", 11, 2),
          (quest_set_slot, "qst_graveyard_duel", 11, 3),
        (else_try),
          (quest_set_slot, "qst_graveyard_duel", 11, 1),
        (try_end),
        (set_spawn_radius, 4),
        (spawn_around_party, "p_graveyard_1", "pt_looters"),
        (assign, ":var1", reg0),
        (party_add_members, ":var1", "trp_vagabond", 4),
        (party_remove_members, ":var1", "trp_looter_1", 99),
        (call_script, "script_loot_player_items", ":var1"),
        (assign, "$auto_enter_town", "p_graveyard_1"),
        (call_script, "script_change_troop_renown", "trp_player", -4),
        (assign, "$duel", 0),
        (finish_mission, 4),
      (else_try),
        (try_begin),
          (quest_slot_eq, "qst_graveyard_duel", 11, 1),
          (quest_set_slot, "qst_graveyard_duel", 11, 4),
        (else_try),
          (quest_set_slot, "qst_graveyard_duel", 11, 2),
          (call_script, "script_change_troop_renown", "trp_player", 8),
        (try_end),
        (assign, "$duel", 5),
      (try_end),
    ],
    [
      (assign, "$auto_enter_town", "p_graveyard_1"),
      (assign, "$duel", 0),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [
      (eq, "$duel", 3),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_wielded_item, ":var1", ":var0", 0),
        (gt, ":var1", -1),
        (display_message, "@You infringed the duel rules!"),
        (call_script, "script_change_troop_renown", "trp_player", -5),
        (call_script, "script_change_player_honor", -5),
        (set_party_battle_mode),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (this_or_next|eq, ":var3", "$duel_partner_b"),
          (eq, ":var3", "$duel_partner"),
          (agent_set_team, ":var2", 2),
        (try_end),
        (quest_set_slot, "qst_graveyard_duel", 11, 1),
        (assign, "$duel", 1),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 10),
        (dialog_box, "@Leave your gun in the holster. Wait until the the bell rings and pull your gun.", "@duel"),
      (try_end),
      (try_begin),
        (eq, "$countdown_to_duel", 0),
        (set_party_battle_mode),
        (assign, ":var4", 1),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (this_or_next|eq, ":var3", "$duel_partner_b"),
          (eq, ":var3", "$duel_partner"),
          (val_add, ":var4", 1),
          (agent_set_team, ":var2", ":var4"),
        (try_end),
      (try_end),
      (try_begin),
        (gt, "$countdown_to_duel", 0),
        (play_sound, "snd_clocktick"),
      (else_try),
        (play_sound, "snd_Bell"),
        (assign, "$duel", 1),
      (try_end),
      (val_sub, "$countdown_to_duel", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("rob_bank_fight", mtf_arena_fight, -1,
  "You must fight your way out!",
  [
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (replace_scene_props, "spr_troop_wanted_sign", "spr_troop_wanted_sign_no_agent"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_wish_to_surrender"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (call_script, "script_loot_player_items", "$g_encountered_party"),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sneak_town_halt"),
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 3, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (call_script, "script_loot_player_items", "$g_encountered_party"),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (5, 1, ti_once, 
    [
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
    ],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (set_spawn_radius, 4),
      (spawn_around_party, "$g_encountered_party", "pt_bank_defenders"),
      (assign, ":var0", reg0),
      (store_faction_of_party, ":var1", "$g_encountered_party"),
      (party_set_faction, ":var0", ":var1"),
      (party_set_ai_behavior, ":var0", ai_bhvr_attack_party),
      (party_set_ai_object, ":var0", p_main_party),
      (party_set_flags, ":var0", 65536, 0),
      (party_set_slot, ":var0", 4, 13),
      (party_set_slot, ":var0", 123, "$g_encountered_party"),
      (finish_mission, 1),
    ]),

    (ti_on_leave_area, 0, ti_once, 
    [],
    [
      (assign, "$auto_menu", -1),
      (set_spawn_radius, 4),
      (spawn_around_party, "$g_encountered_party", "pt_bank_defenders"),
      (assign, ":var0", reg0),
      (store_faction_of_party, ":var1", "$g_encountered_party"),
      (party_set_faction, ":var0", ":var1"),
      (party_set_ai_behavior, ":var0", ai_bhvr_attack_party),
      (party_set_ai_object, ":var0", p_main_party),
      (party_set_flags, ":var0", 65536, 0),
      (party_set_slot, ":var0", 4, 13),
      (party_set_slot, ":var0", 123, "$g_encountered_party"),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("tull", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, [itm_sharps_pepperbox,itm_cartridges,itm_scalpingknife,itm_poncho_b,itm_wrapping_boots,itm_sombrero_c]),
    (1, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_1|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_2|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    [
      (set_fog_distance, 40),
      (try_for_agents, ":var0"),
        (agent_get_entry_no, ":var1", ":var0"),
        (is_between, ":var1", 6, 19),
        (agent_set_animation, ":var0", "anim_unused_human_anim_4"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [
      (assign, "$tull_zombie_spawned", -10),
    ],
    [
      (set_rain, 1, 100),
    ]),

    (1, 0, ti_once, 
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos1, ":var0"),
      (scene_prop_get_instance, ":var1", "spr_small_chest_1866", 0),
      (prop_instance_get_position, pos2, ":var1"),
      (get_distance_between_positions, ":var2", pos1, pos2),
      (le, ":var2", 1000),
      (assign, "$tull_zombie_spawned", 0),
    ],
    []),

    (8, 0, 0, 
    [
      (ge, "$tull_zombie_spawned", 0),
    ],
    [
      (val_add, "$tull_zombie_spawned", 1),
      (try_for_agents, ":var0"),
        (agent_get_entry_no, ":var1", ":var0"),
        (val_sub, ":var1", 6),
        (is_between, ":var1", 0, 14),
        (eq, "$tull_zombie_spawned", ":var1"),
        (agent_set_animation, ":var0", "anim_zombie_get_up"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (call_script, "script_override_unuseable_items_sub", "trp_player"),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

  ("buffalo_hunting", mtf_arena_fight, -1,
  "You lead your buffalo to battle.",
  [
    (1, mtef_team_0|mtef_no_companions|mtef_no_regulars, 0, aif_start_alarmed, 12, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_defenders, 0, aif_start_alarmed, 20, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (assign, "$stop_hunting", 1),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$stop_hunting", 0),
      (assign, "$num_buffalos_killed", 0),
      (assign, "$leading_buffalo", 0),
    ],
    []),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, reg1),
        (agent_get_item_id, reg2, reg1),
        (this_or_next|eq, reg2, "itm_deer"),
        (eq, reg2, "itm_buffalo"),
        (store_agent_hit_points, reg2, reg1),
        (store_mul, reg3, 20, reg2),
        (val_div, reg3, 40),
        (agent_get_rider, ":var0", reg1),
        (gt, ":var0", -1),
        (agent_set_speed_limit, ":var0", reg3),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (this_or_next|eq, "$leading_buffalo", 0),
      (neg|agent_is_alive, "$leading_buffalo"),
    ],
    [
      (try_for_agents, reg1),
        (agent_get_item_id, reg2, reg1),
        (this_or_next|eq, reg2, "itm_deer"),
        (eq, reg2, "itm_buffalo"),
        (assign, "$leading_buffalo", reg1),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (call_script, "script_hunting_count_living_animals"),
      (assign, ":var0", reg0),
      (party_count_members_of_type, ":var1", "$g_encountered_party", "trp_buffalo"),
      (party_count_members_of_type, ":var2", "$g_encountered_party", "trp_deer"),
      (val_add, ":var1", ":var2"),
      (store_sub, ":var3", ":var1", ":var0"),
      (gt, ":var3", "$num_buffalos_killed"),
      (get_scene_boundaries, pos10, pos11),
      (position_get_x, ":var4", pos10),
      (position_get_x, ":var5", pos11),
      (position_get_y, ":var6", pos10),
      (position_get_y, ":var7", pos11),
      (store_div, ":var8", ":var5", 10),
      (val_add, ":var4", ":var8"),
      (val_sub, ":var5", ":var8"),
      (store_div, ":var9", ":var7", 10),
      (val_add, ":var6", ":var9"),
      (val_sub, ":var7", ":var9"),
      (store_random_in_range, ":var10", ":var4", ":var5"),
      (store_random_in_range, ":var11", ":var6", ":var7"),
      (init_position, pos1),
      (position_set_x, pos1, ":var10"),
      (position_set_y, pos1, ":var11"),
      (position_set_z, pos1, 10000),
      (position_set_z_to_ground_level, pos1),
      (gt, "$leading_buffalo", 0),
      (agent_is_alive, "$leading_buffalo"),
      (agent_get_rider, ":var12", "$leading_buffalo"),
      (gt, ":var12", -1),
      (agent_set_scripted_destination, ":var12", pos1),
      (assign, "$num_buffalos_killed", ":var3"),
    ]),

    (0, 0, 0, 
    [],
    [
      (store_mission_timer_a, reg10),
      (try_begin),
        (this_or_next|ge, reg10, 60),
        (this_or_next|eq, "$stop_hunting", 1),
        (num_active_teams_le, 1),
        (party_count_members_of_type, ":var0", "$g_encountered_party", "trp_buffalo"),
        (party_count_members_of_type, ":var1", "$g_encountered_party", "trp_deer"),
        (val_add, ":var0", ":var1"),
        (call_script, "script_hunting_count_living_animals"),
        (assign, ":var2", reg0),
        (store_sub, "$num_buffalos_killed", ":var0", ":var2"),
        (assign, reg8, 0),
        (try_begin),
          (gt, ":var0", 0),
          (store_random_in_range, ":var3", 1, ":var0"),
          (party_remove_members, "$g_encountered_party", "trp_buffalo", ":var3"),
          (party_remove_members, "$g_encountered_party", "trp_deer", ":var3"),
          (assign, reg8, ":var3"),
        (try_end),
        (assign, reg9, "$num_buffalos_killed"),
        (display_message, "@You killed {reg9} animals."),
        (display_message, "@{reg8} animals have escaped!"),
        (reset_mission_timer_a),
        (finish_mission, 0),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (5, 0, 0, 
    [],
    [
      (gt, "$leading_buffalo", 0),
      (agent_is_alive, "$leading_buffalo"),
      (agent_get_position, pos1, "$leading_buffalo"),
      (position_get_x, ":var0", pos1),
      (position_get_y, ":var1", pos1),
      (get_scene_boundaries, pos10, pos11),
      (position_get_x, ":var2", pos10),
      (position_get_x, ":var3", pos11),
      (position_get_y, ":var4", pos10),
      (position_get_y, ":var5", pos11),
      (store_div, ":var6", ":var3", 10),
      (val_add, ":var2", ":var6"),
      (val_sub, ":var3", ":var6"),
      (store_div, ":var7", ":var5", 10),
      (val_add, ":var4", ":var7"),
      (val_sub, ":var5", ":var7"),
      (this_or_next|le, ":var0", ":var2"),
      (this_or_next|le, ":var1", ":var4"),
      (this_or_next|ge, ":var0", ":var3"),
      (ge, ":var1", ":var5"),
      (store_random_in_range, ":var0", ":var2", ":var3"),
      (store_random_in_range, ":var1", ":var4", ":var5"),
      (init_position, pos1),
      (position_set_x, pos1, ":var0"),
      (position_set_y, pos1, ":var1"),
      (position_set_z, pos1, 10000),
      (position_set_z_to_ground_level, pos1),
      (agent_get_rider, ":var8", "$leading_buffalo"),
      (gt, ":var8", -1),
      (agent_set_scripted_destination, ":var8", pos1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, reg1),
        (agent_get_item_id, reg2, reg1),
        (this_or_next|eq, reg2, "itm_deer"),
        (eq, reg2, "itm_buffalo"),
        (store_agent_hit_points, ":var0", reg1),
        (store_sub, ":var1", 100, ":var0"),
        (agent_get_slot, ":var2", reg1, 1),
        (neq, ":var2", ":var1"),
        (agent_set_slot, reg1, 1, ":var1"),
        (agent_get_position, pos1, reg1),
        (position_get_x, ":var3", pos1),
        (position_get_y, ":var4", pos1),
        (store_random_in_range, ":var5", 0, 1000),
        (store_random_in_range, ":var6", 0, 1000),
        (val_add, ":var3", ":var5"),
        (val_add, ":var4", ":var6"),
        (position_set_x, pos1, ":var3"),
        (position_set_y, pos1, ":var4"),
        (agent_get_rider, ":var7", reg1),
        (gt, ":var7", -1),
        (agent_set_scripted_destination, ":var7", pos1),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [],
    [
      (gt, "$leading_buffalo", 0),
      (agent_is_alive, "$leading_buffalo"),
      (get_player_agent_no, reg1),
      (agent_get_position, pos1, reg1),
      (agent_get_position, pos4, "$leading_buffalo"),
      (position_get_x, ":var0", pos4),
      (position_get_y, ":var1", pos4),
      (try_for_agents, reg1),
        (try_begin),
          (agent_get_horse, ":var2", reg1),
          (eq, ":var2", -1),
          (agent_get_team, ":var3", reg1),
          (eq, ":var3", 1),
          (set_show_messages, 0),
          (agent_set_hit_points, reg1, 0),
          (agent_deliver_damage_to_agent, reg1, reg1),
          (set_show_messages, 1),
        (try_end),
        (try_begin),
          (agent_get_team, ":var3", reg1),
          (eq, ":var3", 1),
          (agent_get_horse, ":var2", reg1),
          (gt, ":var2", -1),
          (agent_set_hit_points, reg1, 100),
        (try_end),
        (agent_get_item_id, reg2, reg1),
        (this_or_next|eq, reg2, "itm_deer"),
        (eq, reg2, "itm_buffalo"),
        (agent_get_position, pos2, reg1),
        (get_distance_between_positions, reg3, pos1, pos2),
        (try_begin),
          (le, reg3, 2500),
          (position_get_x, reg4, pos1),
          (position_get_x, reg5, pos2),
          (store_sub, ":var4", reg5, reg4),
          (val_mul, ":var4", 10),
          (position_get_y, reg6, pos1),
          (position_get_y, reg7, pos2),
          (store_sub, ":var5", reg7, reg6),
          (val_mul, ":var5", 10),
          (init_position, pos3),
          (val_add, ":var4", reg5),
          (val_add, ":var5", reg7),
          (position_set_x, pos3, ":var4"),
          (position_set_y, pos3, ":var5"),
          (position_set_z, pos3, 10000),
          (position_set_z_to_ground_level, pos3),
          (agent_get_rider, ":var6", reg1),
          (gt, ":var6", -1),
          (agent_set_scripted_destination, ":var6", pos3),
        (else_try),
          (get_distance_between_positions, reg3, pos4, pos2),
          (ge, reg3, 2000),
          (init_position, pos6),
          (store_random_in_range, ":var7", 0, 1000),
          (store_random_in_range, ":var8", 0, 1000),
          (val_add, ":var7", ":var0"),
          (val_add, ":var8", ":var1"),
          (position_set_x, pos6, ":var7"),
          (position_set_y, pos6, ":var8"),
          (position_set_z, pos6, 10000),
          (position_set_z_to_ground_level, pos6),
          (agent_get_rider, ":var6", reg1),
          (gt, ":var6", -1),
          (agent_set_scripted_destination, ":var6", pos6),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$order_move_to_pos43_start", 0),
      (assign, "$hold_key_1second", 0),
    ]),

    (0, 1, 0, 
    [
      (try_begin),
        (neg|game_key_is_down, 21),
        (assign, "$hold_key_1second", 0),
      (try_end),
      (game_key_is_down, 21),
    ],
    [
      (try_begin),
        (game_key_is_down, 21),
        (assign, "$hold_key_1second", 1),
      (try_end),
    ]),

    (0.05, 0, 0, 
    [
      (game_key_is_down, 21),
      (eq, "$hold_key_1second", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_look_position, pos1, ":var0"),
      (position_move_z, pos1, 120),
      (try_begin),
        (call_script, "script_shift_pos1_along_y_axis_to_ground", 100, 30000),
        (assign, "$order_move_to_pos43_start", 1),
        (particle_system_burst, "psys_fat_arrow", pos1, 1),
        (copy_position, pos43, pos1),
      (else_try),
        (assign, "$order_move_to_pos43_start", 0),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$order_move_to_pos43_start", 1),
      (neg|game_key_is_down, 21),
      (assign, "$order_move_to_pos43_start", 0),
      (particle_system_burst, "psys_fat_arrow_rising", pos43, 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (try_begin),
        (class_is_listening_order, ":var1", 0),
        (class_is_listening_order, ":var1", 1),
        (class_is_listening_order, ":var1", 2),
        (team_give_order, ":var1", 10, 0),
        (team_set_order_position, ":var1", 10, pos43),
        (str_store_string, s1, "@everyone"),
      (else_try),
        (class_is_listening_order, ":var1", 0),
        (team_give_order, ":var1", 0, 0),
        (team_set_order_position, ":var1", 0, pos43),
        (str_store_string, s1, "@infantry"),
      (else_try),
        (class_is_listening_order, ":var1", 1),
        (team_give_order, ":var1", 1, 0),
        (team_set_order_position, ":var1", 1, pos43),
        (str_store_string, s1, "@Archers"),
      (else_try),
        (team_give_order, ":var1", 2, 0),
        (team_set_order_position, ":var1", 2, pos43),
        (str_store_string, s1, "@cavalry"),
      (try_end),
      (set_show_messages, 1),
      (display_message, "@{s1}, move over there!"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$timer", 0),
      (assign, "$bullet_timer", 0),
      (assign, "$timer_speed", 10),
      (assign, "$bullet_timer_speed", 1),
      (try_for_range, ":var0", 0, 256),
        (troop_set_slot, "trp_pjct_active", ":var0", 0),
        (troop_set_slot, "trp_bullet_active", ":var0", 0),
      (try_end),
      (try_for_range, ":var1", 0, "spr_scene_props_end"),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (troop_set_slot, "trp_instance_attached_to", ":var4", 0),
        (try_end),
      (try_end),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite"),
      (call_script, "script_cf_move_scene_props_underground", "spr_dynamite_big"),
    ]),

    (0.1, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 256),
        (troop_slot_eq, "trp_pjct_active", ":var0", 1),
        (troop_get_slot, ":var1", "trp_pjct_emit_time", ":var0"),
        (troop_get_slot, ":var2", "trp_pjct_x", ":var0"),
        (troop_get_slot, ":var3", "trp_pjct_y", ":var0"),
        (troop_get_slot, ":var4", "trp_pjct_z", ":var0"),
        (troop_get_slot, ":var5", "trp_pjct_last_x", ":var0"),
        (troop_get_slot, ":var6", "trp_pjct_last_y", ":var0"),
        (troop_get_slot, ":var7", "trp_pjct_last_z", ":var0"),
        (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
        (troop_get_slot, ":var9", "trp_pjct_x_velocity", ":var0"),
        (troop_get_slot, ":var10", "trp_pjct_y_velocity", ":var0"),
        (troop_get_slot, ":var11", "trp_pjct_z_velocity", ":var0"),
        (init_position, pos1),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z, pos1, ":var7"),
        (troop_get_slot, ":var12", "trp_pjct_hit_ground", ":var0"),
        (try_begin),
          (neq, ":var12", 1),
          (store_sub, ":var13", "$timer", ":var1"),
          (val_mul, ":var9", ":var13"),
          (val_mul, ":var10", ":var13"),
          (val_mul, ":var11", ":var13"),
          (assign, ":var14", 981),
          (val_mul, ":var14", ":var13"),
          (val_mul, ":var14", ":var13"),
          (val_div, ":var14", 20000),
          (store_add, ":var15", ":var2", ":var9"),
          (store_add, ":var16", ":var3", ":var10"),
          (val_sub, ":var11", ":var14"),
          (store_add, ":var17", ":var4", ":var11"),
          (init_position, pos2),
          (position_set_x, pos2, ":var15"),
          (position_set_y, pos2, ":var16"),
          (position_set_z, pos2, ":var17"),
          (call_script, "script_position_face_position", 1, 2),
          (position_copy_rotation, pos2, pos1),
          (troop_set_slot, "trp_pjct_last_x", ":var0", ":var15"),
          (troop_set_slot, "trp_pjct_last_y", ":var0", ":var16"),
          (troop_set_slot, "trp_pjct_last_z", ":var0", ":var17"),
        (try_end),
        (troop_get_slot, ":var18", "trp_pjct_particle_system", ":var0"),
        (try_begin),
          (ge, ":var18", 0),
          (particle_system_burst, ":var18", pos1, 10),
        (try_end),
        (store_mul, ":var19", ":var9", ":var9"),
        (store_mul, ":var20", ":var10", ":var10"),
        (val_add, ":var19", ":var20"),
        (store_mul, ":var20", ":var11", ":var11"),
        (val_add, ":var19", ":var20"),
        (store_sqrt, ":var21", ":var19"),
        (try_begin),
          (troop_get_slot, ":var22", "trp_pjct_damage", ":var0"),
          (ge, ":var22", 1),
          (try_for_agents, ":var23"),
            (agent_is_alive, ":var23"),
            (agent_get_position, pos3, ":var23"),
            (position_move_z, pos3, 100),
            (position_transform_position_to_local, pos4, pos1, pos3),
            (position_get_y, ":var24", pos4),
            (is_between, ":var24", 0, ":var21"),
            (position_get_x, ":var25", pos4),
            (is_between, ":var25", -40, 40),
            (position_get_z, ":var26", pos4),
            (is_between, ":var26", -100, 110),
            (assign, ":var27", 1),
          (try_end),
        (try_end),
        (position_get_z, ":var26", pos1),
        (copy_position, pos3, pos2),
        (position_set_z_to_ground_level, pos3),
        (position_get_z, ":var28", pos3),
        (store_sub, ":var29", ":var26", ":var28"),
        (assign, ":var27", 0),
        (try_begin),
          (troop_get_slot, ":var30", "trp_pjct_explosion_countdown", ":var0"),
          (gt, "$timer", ":var30"),
          (assign, ":var27", 1),
        (else_try),
          (neq, ":var12", 1),
          (le, ":var29", 0),
          (troop_get_slot, ":var31", "trp_pjct_explode_on_ground_hit", ":var0"),
          (try_begin),
            (eq, ":var31", 1),
            (assign, ":var27", 1),
          (else_try),
            (init_position, pos3),
            (position_copy_rotation, pos1, pos3),
            (position_set_z_to_ground_level, pos1),
            (position_move_z, pos1, 10),
            (position_get_z, ":var32", pos1),
            (troop_set_slot, "trp_pjct_last_x", ":var0", ":var5"),
            (troop_set_slot, "trp_pjct_last_y", ":var0", ":var6"),
            (troop_set_slot, "trp_pjct_last_z", ":var0", ":var32"),
            (troop_set_slot, "trp_pjct_hit_ground", ":var0", 1),
            (assign, ":var12", 1),
          (try_end),
        (try_end),
        (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
        (store_mul, ":var34", 2, "$timer_speed"),
        (try_begin),
          (ge, ":var33", 0),
          (neq, ":var12", 1),
          (prop_instance_animate_to_position, ":var33", pos2, ":var34"),
        (else_try),
          (ge, ":var33", 0),
          (prop_instance_animate_to_position, ":var33", pos1, "$timer_speed"),
        (try_end),
        (try_begin),
          (eq, ":var27", 1),
          (troop_get_slot, ":var35", "trp_pjct_explosive", ":var0"),
          (try_begin),
            (eq, ":var35", 1),
            (troop_get_slot, ":var36", "trp_pjct_explosion_area", ":var0"),
            (troop_get_slot, ":var37", "trp_pjct_explosion_damage", ":var0"),
            (troop_get_slot, ":var8", "trp_pjct_source_agent", ":var0"),
            (call_script, "script_explosion_at_pos1", ":var36", ":var37", ":var8"),
          (try_end),
          (troop_set_slot, "trp_pjct_active", ":var0", 0),
          (troop_get_slot, ":var33", "trp_pjct_attach_scene_prop", ":var0"),
          (try_begin),
            (ge, ":var33", 0),
            (troop_set_slot, "trp_instance_attached_to", ":var33", 0),
            (init_position, pos1),
            (position_set_z, pos1, -100000),
            (prop_instance_animate_to_position, ":var33", pos1, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0.1, 0, 0, 
    [
      (val_add, "$timer", "$timer_speed"),
    ],
    []),

    (0.01, 0, 0, 
    [
      (val_add, "$bullet_timer", "$bullet_timer_speed"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (scene_prop_get_num_instances, ":var0", "spr_item_shotgun"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_shotgun", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_doublebarrelshotgun"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_coltwalker"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_coltwalker", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_colt_walker_44"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_ball_warclub"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_ball_warclub", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_ball_warclub"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_2by4"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_2by4", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_2by4"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_springfield_07"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_springfield_07", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_springfield_07"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_mighty_broom"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_mighty_broom"),
      (try_end),
      (scene_prop_get_num_instances, ":var0", "spr_item_stones_of_death"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "spr_item_broom", ":var1"),
        (prop_instance_get_position, pos1, ":var2"),
        (set_spawn_position, pos1),
        (spawn_item, "itm_stones_of_death"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, 21),
      (this_or_next|game_key_clicked, 22),
      (this_or_next|game_key_clicked, 23),
      (this_or_next|game_key_clicked, 24),
      (this_or_next|game_key_clicked, 26),
      (this_or_next|game_key_clicked, 27),
      (this_or_next|game_key_clicked, 28),
      (this_or_next|game_key_clicked, 29),
      (this_or_next|game_key_clicked, 25),
      (this_or_next|game_key_clicked, 30),
      (this_or_next|game_key_clicked, 31),
      (this_or_next|game_key_clicked, 32),
      (this_or_next|game_key_clicked, 33),
      (this_or_next|game_key_clicked, 34),
      (game_key_clicked, 35),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_for_range, ":var3", 0, 11),
        (class_is_listening_order, ":var2", ":var3"),
        (assign, ":var4", ":var3"),
      (try_end),
      (try_begin),
        (game_key_clicked, 21),
        (assign, ":var0", "snd_american_soldier_hold_position"),
      (else_try),
        (game_key_clicked, 22),
        (assign, ":var0", "snd_american_soldier_follow_me"),
      (else_try),
        (game_key_clicked, 23),
        (assign, ":var0", "snd_american_soldier_charge"),
      (else_try),
        (game_key_clicked, 24),
        (team_get_riding_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_dismount"),
        (else_try),
          (eq, ":var5", 2),
          (assign, ":var0", "snd_american_soldier_mount"),
        (try_end),
      (else_try),
        (game_key_clicked, 26),
        (assign, ":var0", "snd_american_soldier_advance"),
      (else_try),
        (game_key_clicked, 27),
        (assign, ":var0", "snd_american_soldier_fall_back"),
      (else_try),
        (game_key_clicked, 28),
        (assign, ":var0", "snd_american_soldier_closer"),
      (else_try),
        (game_key_clicked, 29),
        (assign, ":var0", "snd_american_soldier_apart"),
      (else_try),
        (game_key_clicked, 25),
        (team_get_hold_fire_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_hold_fire"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", "snd_american_soldier_fire_at_will"),
        (try_end),
      (else_try),
        (game_key_clicked, 30),
        (team_get_weapon_usage_order, ":var5", ":var2", ":var4"),
        (try_begin),
          (eq, ":var5", 0),
          (assign, ":var0", "snd_american_soldier_prisoners"),
        (else_try),
          (eq, ":var5", 1),
          (assign, ":var0", 0),
        (try_end),
      (else_try),
        (game_key_clicked, 31),
        (assign, ":var0", "snd_american_soldier_everyone"),
      (else_try),
        (game_key_clicked, 32),
        (assign, ":var0", "snd_american_soldier_infantry"),
      (else_try),
        (game_key_clicked, 33),
        (assign, ":var0", "snd_american_soldier_riflemen"),
      (else_try),
        (game_key_clicked, 34),
        (assign, ":var0", "snd_american_soldier_cavalry"),
      (try_end),
      (try_begin),
        (neq, ":var0", 0),
        (assign, ":var6", 0),
        (try_begin),
          (eq, "$g_player_voice", 0),
          (assign, ":var0", 0),
        (else_try),
          (eq, "$g_player_voice", 1),
          (assign, ":var6", 0),
        (else_try),
          (eq, "$g_player_voice", 2),
          (assign, ":var6", 20),
        (else_try),
          (eq, "$g_player_voice", 3),
          (assign, ":var6", 40),
        (else_try),
          (eq, "$g_player_voice", 4),
          (assign, ":var6", 60),
        (else_try),
          (eq, "$g_player_voice", 5),
          (assign, ":var6", 80),
        (else_try),
          (display_message, "@ERROR: player voice out of range: {reg1}"),
          (assign, ":var0", 0),
        (try_end),
        (try_begin),
          (neq, ":var0", 0),
          (val_add, ":var0", ":var6"),
          (play_sound, ":var0"),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$elpaso_house_bought", 1),
        (replace_scene_props, "spr_el_paso_door", "spr_el_paso_door_empty"),
      (else_try),
        (replace_scene_props, "spr_el_paso_door_empty", "spr_el_paso_door"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_u),
      (eq, 0, 1),
    ],
    [
      (start_presentation, "prsnt_player_wounded"),
    ]),

    (3, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (eq, ":var2", -1),
        (store_agent_hit_points, ":var3", ":var1", 1),
        (le, ":var3", 7),
        (store_random_in_range, ":var4", 0, 100),
        (store_mul, ":var5", ":var3", 13),
        (agent_set_speed_limit, ":var1", 2),
        (try_begin),
          (gt, ":var4", ":var5"),
          (agent_set_animation, ":var1", "anim_unused_human_anim_5"),
          (agent_get_position, pos1, ":var1"),
          (position_move_z, pos1, 120),
          (position_move_y, pos1, 20),
          (particle_system_burst, "psys_game_blood", pos1, 100),
          (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (try_end),
        (try_begin),
          (is_between, ":var4", 0, 40),
          (neg|main_hero_fallen),
          (neg|num_active_teams_le, 1),
          (val_sub, ":var3", 1),
          (agent_set_hit_points, ":var1", ":var3", 1),
          (try_begin),
            (eq, ":var3", 0),
            (set_show_messages, 0),
            (agent_set_slot, ":var1", 5, 1),
            (agent_deliver_damage_to_agent, ":var1", ":var1"),
            (set_show_messages, 1),
            (agent_get_troop_id, ":var6", ":var1"),
            (str_store_troop_name, s1, ":var6"),
            (try_begin),
              (agent_is_wounded, ":var1"),
              (display_message, "@{s1} fell unconscious from blood loss."),
            (else_try),
              (display_message, "@{s1} died of blood loss."),
            (try_end),
          (else_try),
            (agent_play_sound, ":var1", "snd_man_breath_hard"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (key_clicked, key_left_alt),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_wielded_item, ":var2", ":var0", 0),
      (gt, ":var2", -1),
      (item_get_slot, ":var3", ":var2", 12),
      (gt, ":var3", 0),
      (set_show_messages, 0),
      (agent_get_horse, ":var4", ":var0"),
      (troop_get_inventory_slot, ":var5", "trp_player", ek_horse),
      (troop_get_inventory_slot_modifier, ":var6", "trp_player", ek_horse),
      (init_position, pos2),
      (try_begin),
        (lt, ":var4", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (agent_get_item_id, ":var7", ":var4"),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var7"),
        (agent_set_position, ":var4", pos2),
      (try_end),
      (try_for_range, ":var8", 0, 4),
        (troop_get_inventory_slot, ":var9", "trp_player", ":var8"),
        (troop_get_inventory_slot_modifier, ":var10", "trp_player", ":var8"),
        (eq, ":var9", ":var2"),
        (troop_get_inventory_slot, ":var11", "trp_player", ek_item_0),
        (troop_get_inventory_slot_modifier, ":var12", "trp_player", ek_item_0),
        (troop_set_inventory_slot, "trp_player", ek_item_0, ":var3"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_item_0, ":var10"),
        (neq, ":var8", 0),
        (troop_set_inventory_slot, "trp_player", ":var8", ":var11"),
        (troop_set_inventory_slot_modifier, "trp_player", ":var8", ":var12"),
      (try_end),
      (store_agent_hit_points, ":var13", ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_position, ":var0", pos2),
      (call_script, "script_dmod_kill_agent", ":var0"),
      (set_spawn_position, pos1),
      (spawn_agent, "trp_player"),
      (agent_set_hit_points, reg0, ":var13", 1),
      (agent_set_team, reg0, ":var1"),
      (try_begin),
        (lt, ":var5", 0),
        (troop_set_inventory_slot, "trp_player", ek_horse, "itm_no_item"),
        (troop_remove_item, "trp_player", "itm_no_item"),
      (else_try),
        (troop_set_inventory_slot, "trp_player", ek_horse, ":var5"),
        (troop_set_inventory_slot_modifier, "trp_player", ek_horse, ":var6"),
      (try_end),
      (set_show_messages, 1),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (set_rain, 2, 0),
    ]),

  ]),

]